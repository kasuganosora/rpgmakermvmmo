/*:
 * @plugindesc v2.0.0 MMO UI - Lineage 2 style canvas UI component library (DDD build).
 * @author MMO Framework
 *
 * Auto-generated by ui/build.js — DO NOT EDIT DIRECTLY.
 * Edit individual component files under ui/ and rebuild.
 *
 * Components (46 files):
 *   Core:       L2_Theme, L2_Base
 *   Layout:     L2_Divider, L2_Grid, L2_Layout, L2_Space
 *   Base:       L2_Button, L2_Icon, L2_Link, L2_Typography
 *   Navigation: L2_Tabs, L2_Menu, L2_Dropdown, L2_Pagination, L2_Steps, L2_Breadcrumb
 *   Window:     L2_SubWindow, L2_FullscreenWindow
 *   Input:      L2_Input, L2_InputNumber, L2_Select, L2_Checkbox, L2_Radio, L2_Switch, L2_Slider, L2_Textarea
 *   Data:       L2_List, L2_Table, L2_Card, L2_Progress, L2_Tag, L2_Badge, L2_Avatar, L2_Collapse, L2_Tooltip, L2_Tree, L2_Statistic, L2_Empty, L2_Loading
 *   Feedback:   L2_Dialog, L2_Drawer, L2_Message, L2_Notification, L2_Alert, L2_Popconfirm
 */

// ═══ ui/core/theme.js ═══
/**
 * L2_Theme - Lineage 2 style color palette and drawing helpers.
 * All rendering through RMMV Bitmap canvas context.
 */
(function () {
    'use strict';

    var L2_Theme = {
        // ── Backgrounds ──
        bgDark:        '#0D0D1A',
        bgPanel:       '#151528',
        bgInput:       '#0A0A18',
        bgButton:      '#1A1A30',
        bgButtonHover: '#252545',
        bgButtonPress: '#111125',
        bgTooltip:     '#0C0C1E',
        bgHeader:      '#1E1E38',
        bgHeaderEnd:   '#12122A',
        bgOverlay:     'rgba(0,0,0,0.55)',

        // ── Borders ──
        borderDark:    '#2A2A44',
        borderLight:   '#3A3A55',
        borderGold:    '#8B7500',
        borderActive:  '#BFA530',

        // ── Text ──
        textWhite:     '#E8E8E8',
        textGray:      '#AAAAAA',
        textDim:       '#666666',
        textGold:      '#FFD700',
        textTitle:     '#DDCC88',
        textGreen:     '#44FF88',
        textRed:       '#FF6666',
        textBlue:      '#88CCFF',
        textCyan:      '#66DDDD',
        textLink:      '#6699FF',
        textLinkHover: '#99BBFF',

        // ── Bars ──
        hpFill:   '#CC2222', hpBg:   '#440000',
        mpFill:   '#2222CC', mpBg:   '#000044',
        expFill:  '#CCCC00', expBg:  '#333300',

        // ── Extra Backgrounds ──
        bgLight:       '#222240',

        // ── Misc ──
        highlight:  'rgba(255,255,255,0.06)',
        selection:  'rgba(100,140,255,0.18)',
        shadow:     'rgba(0,0,0,0.55)',
        divider:    '#2A2A44',
        success:    '#44FF88',
        warning:    '#FFAA44',
        error:      '#FF4444',
        info:       '#4488FF',

        // ── Semantic colors (aliases for component API) ──
        primaryColor:  '#4488FF',
        successColor:  '#44FF88',
        warningColor:  '#FFAA44',
        dangerColor:   '#FF4444',

        // ── Constants ──
        scrollbarWidth: 6,
        defaultGap: 4,
        defaultItemHeight: 24,
        defaultBtnHeight: 28,
        charWidth: 7,
        dragThreshold: 3,

        // ── Object Pool Configuration ──
        poolEnabled: true,
        poolMaxSize: 10,

        // ── Font Configuration ──
        // 字体回退链：优先使用系统中文字体，确保中文显示清晰
        fontFamily: '"Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", "Noto Sans CJK SC", sans-serif',
        
        // 字体大小配置（使用偶数大小有助于像素对齐）
        fontH1:     20,
        fontH2:     18,
        fontH3:     16,
        fontTitle:  16,
        fontNormal: 14,
        fontSmall:  12,
        fontTiny:   10,
        
        // 字体渲染选项
        fontSmoothing: false,  // 禁用字体平滑以获得更多像素感
        pixelAlignText: true,  // 强制文字对齐像素

        // ── Measurements ──
        titleBarH:    26,
        padding:      8,
        cornerRadius: 3,
        lineHeight:   24,
        iconSize:     32,
        slotSize:     40,

        // ═══════════════════════════════════════════════════
        //  Drawing Helpers (operate on RMMV Bitmap)
        // ═══════════════════════════════════════════════════

        fillRoundRect: function (bmp, x, y, w, h, r, color) {
            var ctx = bmp._context;
            if (!ctx) { bmp.fillRect(x, y, w, h, color); return; }
            var oldFill = ctx.fillStyle;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = oldFill;
            bmp._setDirty();
        },

        strokeRoundRect: function (bmp, x, y, w, h, r, color, lineW) {
            var ctx = bmp._context;
            if (!ctx) return;
            var oldStroke = ctx.strokeStyle;
            var oldWidth = ctx.lineWidth;
            ctx.strokeStyle = color;
            ctx.lineWidth = lineW || 1;
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
            ctx.stroke();
            ctx.strokeStyle = oldStroke;
            ctx.lineWidth = oldWidth;
            bmp._setDirty();
        },

        drawBar: function (bmp, x, y, w, h, ratio, bgColor, fillColor) {
            bmp.fillRect(x, y, w, h, bgColor);
            if (ratio > 0) {
                var fw = Math.round(w * Math.min(ratio, 1));
                bmp.fillRect(x, y, fw, h, fillColor);
                bmp.fillRect(x, y, fw, Math.max(1, Math.floor(h / 2)), 'rgba(255,255,255,0.12)');
            }
        },

        drawPanelBg: function (bmp, x, y, w, h) {
            L2_Theme.fillRoundRect(bmp, x, y, w, h, L2_Theme.cornerRadius, L2_Theme.bgPanel);
            L2_Theme.strokeRoundRect(bmp, x, y, w, h, L2_Theme.cornerRadius, L2_Theme.borderDark);
        },

        drawTitleBar: function (bmp, x, y, w, h, title) {
            bmp.gradientFillRect(x, y, w, h, L2_Theme.bgHeader, L2_Theme.bgHeaderEnd, false);
            bmp.fillRect(x, y + h - 1, w, 1, L2_Theme.borderDark);
            if (title) {
                bmp.fontSize = L2_Theme.fontTitle;
                bmp.textColor = L2_Theme.textTitle;
                bmp.drawText(title, x + 8, y + 3, w - 36, h - 4, 'left');
            }
        },

        /** drawCloseBtn(bmp, x, y, sizeOrHover, [hover])
         *  Supports 4 args (size defaults to 14) or 5 args. */
        drawCloseBtn: function (bmp, x, y, sizeOrHover, hover) {
            var size, isHover;
            if (typeof sizeOrHover === 'boolean' || hover === undefined && typeof sizeOrHover !== 'number') {
                size = 14; isHover = !!sizeOrHover;
            } else {
                size = sizeOrHover; isHover = !!hover;
            }
            var color = isHover ? L2_Theme.textRed : L2_Theme.textGray;
            var ctx = bmp._context;
            if (!ctx) return;
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            var m = Math.max(3, Math.floor(size * 0.22));
            ctx.beginPath();
            ctx.moveTo(x + m, y + m);
            ctx.lineTo(x + size - m, y + size - m);
            ctx.moveTo(x + size - m, y + m);
            ctx.lineTo(x + m, y + size - m);
            ctx.stroke();
            ctx.restore();
            bmp._setDirty();
        },

        /** Measure text width using a Bitmap context with caching. */
        _textWidthCache: {},
        measureText: function (bmp, text, fontSize) {
            if (!text) return 0;
            // 使用缓存避免重复计算
            var cacheKey = text + '_' + (fontSize || 13);
            var cached = L2_Theme._textWidthCache[cacheKey];
            if (cached !== undefined) return cached;
            
            var ctx = bmp._context;
            if (!ctx) {
                var est = text.length * (fontSize || 13) * 0.6;
                L2_Theme._textWidthCache[cacheKey] = est;
                return est;
            }
            var old = ctx.font;
            ctx.font = (fontSize || 13) + 'px GameFont';
            var w = ctx.measureText(text).width;
            ctx.font = old;
            
            // 限制缓存大小
            if (Object.keys(L2_Theme._textWidthCache).length > 1000) {
                L2_Theme._textWidthCache = {};
            }
            L2_Theme._textWidthCache[cacheKey] = w;
            return w;
        },
        
        /** Clear text width cache. */
        clearTextWidthCache: function () {
            L2_Theme._textWidthCache = {};
        },

        /** Draw a line. */
        drawLine: function (bmp, x1, y1, x2, y2, color, lineW) {
            var ctx = bmp._context;
            if (!ctx) return;
            var oldStroke = ctx.strokeStyle;
            var oldWidth = ctx.lineWidth;
            ctx.strokeStyle = color || L2_Theme.borderDark;
            ctx.lineWidth = lineW || 1;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.strokeStyle = oldStroke;
            ctx.lineWidth = oldWidth;
            bmp._setDirty();
        },

        /** Draw a circle. */
        drawCircle: function (bmp, cx, cy, r, color) {
            var ctx = bmp._context;
            if (!ctx) return;
            var oldFill = ctx.fillStyle;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = oldFill;
            bmp._setDirty();
        },

        /** Draw a checkmark. */
        drawCheck: function (bmp, x, y, size, color) {
            var ctx = bmp._context;
            if (!ctx) return;
            var oldStroke = ctx.strokeStyle;
            var oldWidth = ctx.lineWidth;
            ctx.strokeStyle = color || L2_Theme.textGreen;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x + size * 0.2, y + size * 0.5);
            ctx.lineTo(x + size * 0.4, y + size * 0.75);
            ctx.lineTo(x + size * 0.8, y + size * 0.25);
            ctx.stroke();
            ctx.strokeStyle = oldStroke;
            ctx.lineWidth = oldWidth;
            bmp._setDirty();
        },

        /** Lighten a hex color by a factor (0–1). */
        lighten: function (hex, factor) {
            hex = hex.replace('#', '');
            if (hex.length === 3) {
                hex = hex.charAt(0) + hex.charAt(0) + hex.charAt(1) + hex.charAt(1) + hex.charAt(2) + hex.charAt(2);
            }
            var r = parseInt(hex.charAt(0) + hex.charAt(1), 16);
            var g = parseInt(hex.charAt(2) + hex.charAt(3), 16);
            var b = parseInt(hex.charAt(4) + hex.charAt(5), 16);
            r = Math.min(255, Math.round(r + (255 - r) * factor));
            g = Math.min(255, Math.round(g + (255 - g) * factor));
            b = Math.min(255, Math.round(b + (255 - b) * factor));
            // 使用数组 join 代替字符串拼接，性能更好
            var hexChars = [
                '#',
                (r >> 4).toString(16),
                (r & 0xF).toString(16),
                (g >> 4).toString(16),
                (g & 0xF).toString(16),
                (b >> 4).toString(16),
                (b & 0xF).toString(16)
            ];
            return hexChars.join('');
        },

        /**
         * Wrap text into lines based on max width.
         * @param {string} text - Text to wrap
         * @param {number} maxW - Max width in pixels
         * @param {number} [charW=7] - Average char width
         * @returns {string[]} Array of lines
         */
        wrapText: function (text, maxW, charW) {
            charW = charW || 7;
            if (!text) return [];
            var charsPerLine = Math.max(Math.floor(maxW / charW), 1);
            var result = [];
            var paragraphs = text.split('\n');
            for (var i = 0; i < paragraphs.length; i++) {
                var line = paragraphs[i];
                while (line.length > charsPerLine) {
                    result.push(line.substring(0, charsPerLine));
                    line = line.substring(charsPerLine);
                }
                result.push(line);
            }
            return result;
        },

        /**
         * Wrap text with max char limit per line.
         * @param {string} text - Text to wrap
         * @param {number} maxChars - Max chars per line
         * @returns {string[]} Array of lines
         */
        wrapTextByChars: function (text, maxChars) {
            if (!text) return [];
            maxChars = Math.max(1, maxChars || 30);
            var result = [];
            var paragraphs = text.split('\n');
            for (var i = 0; i < paragraphs.length; i++) {
                var line = paragraphs[i];
                while (line.length > maxChars) {
                    result.push(line.substring(0, maxChars));
                    line = line.substring(maxChars);
                }
                result.push(line);
            }
            return result;
        },

        // ═══════════════════════════════════════════════════
        //  Object Pool Management
        // ═══════════════════════════════════════════════════

        _pools: {},

        /**
         * Acquire an object from pool or create new.
         * @param {string} poolName - Pool identifier
         * @param {Function} factory - Factory function to create new object
         * @returns {object} Pooled or new object
         */
        acquire: function (poolName, factory) {
            if (!L2_Theme.poolEnabled) return factory();
            var pool = L2_Theme._pools[poolName];
            if (pool && pool.length > 0) {
                return pool.pop();
            }
            return factory();
        },

        /**
         * Release object back to pool.
         * @param {string} poolName - Pool identifier
         * @param {object} obj - Object to return to pool
         * @param {Function} resetFn - Function to reset object state
         */
        release: function (poolName, obj, resetFn) {
            if (!L2_Theme.poolEnabled || !obj) return;
            var pool = L2_Theme._pools[poolName];
            if (!pool) {
                pool = [];
                L2_Theme._pools[poolName] = pool;
            }
            if (pool.length < L2_Theme.poolMaxSize) {
                if (resetFn) resetFn(obj);
                pool.push(obj);
            }
        },

        /**
         * Clear all object pools.
         */
        clearPools: function () {
            L2_Theme._pools = {};
        },

        // ═══════════════════════════════════════════════════
        //  Optimized Text Rendering (Pixel-Perfect for CJK)
        // ═══════════════════════════════════════════════════

        /**
         * Configure canvas context for sharp text rendering.
         * @param {CanvasRenderingContext2D} ctx - Canvas context
         * @param {number} fontSize - Font size
         * @param {string} color - Text color
         */
        configureTextContext: function (ctx, fontSize, color) {
            if (!ctx) return;
            ctx.font = fontSize + 'px ' + L2_Theme.fontFamily;
            ctx.fillStyle = color;
            ctx.textBaseline = 'alphabetic';
            // 禁用图像平滑以获得更清晰的文字
            ctx.imageSmoothingEnabled = false;
            ctx.imageSmoothingQuality = 'low';
        },

        /**
         * Draw text with pixel-perfect alignment.
         * Ensures text coordinates are integers for sharp rendering.
         * @param {Bitmap} bmp - RMMV Bitmap
         * @param {string} text - Text to draw
         * @param {number} x - X position
         * @param {number} y - Y position
         * @param {number} maxW - Max width
         * @param {number} lineH - Line height
         * @param {string} align - Alignment ('left'|'center'|'right')
         */
        drawTextSharp: function (bmp, text, x, y, maxW, lineH, align) {
            var ctx = bmp._context;
            if (!ctx) return;
            
            // 确保坐标为整数，避免子像素模糊
            var px = Math.round(x);
            var py = Math.round(y);
            var h = Math.round(lineH || bmp.fontSize || 14);
            
            // 计算文本 Y 位置（基线对齐）
            var baseline = Math.round(py + h * 0.75); // 0.75 是视觉中心到基线的比例
            
            var tx = px;
            var mw = Math.round(maxW || 0);
            
            if (align === 'center') {
                tx = px + Math.floor(mw / 2);
            } else if (align === 'right') {
                tx = px + mw;
            }
            
            // 设置字体渲染选项
            ctx.textAlign = align || 'left';
            
            // 绘制文字
            ctx.fillText(String(text), tx, baseline, maxW || undefined);
        },

        /**
         * Measure text width with current font settings.
         * Caches font configuration to avoid repeated DOM lookups.
         * @param {CanvasRenderingContext2D} ctx - Canvas context
         * @param {string} text - Text to measure
         * @param {number} fontSize - Font size
         * @returns {number} Text width
         */
        measureTextSharp: function (ctx, text, fontSize) {
            if (!ctx) return (text || '').length * (fontSize || 14) * 0.6;
            var cacheKey = 'fs' + (fontSize || 14);
            var oldFont = ctx.font;
            ctx.font = (fontSize || 14) + 'px ' + L2_Theme.fontFamily;
            var w = ctx.measureText(text || '').width;
            ctx.font = oldFont;
            return Math.round(w);
        },

        /**
         * Enable/disable pixel alignment for text rendering.
         * @param {CanvasRenderingContext2D} ctx - Canvas context
         * @param {boolean} enabled - Whether to enable pixel alignment
         */
        setPixelAlignment: function (ctx, enabled) {
            if (!ctx) return;
            if (enabled) {
                ctx.imageSmoothingEnabled = false;
                ctx.imageSmoothingQuality = 'low';
                if (ctx.textRendering) ctx.textRendering = 'pixelated';
            } else {
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                if (ctx.textRendering) ctx.textRendering = 'auto';
            }
        }
    };

    window.L2_Theme = L2_Theme;

    // ═══════════════════════════════════════════════════
    //  Auto-initialization for RPG Maker MV
    // ═══════════════════════════════════════════════════

    /**
     * Apply pixel-perfect rendering settings for RPG Maker MV.
     * This is called automatically when the library loads.
     */
    function _applyPixelSettings() {
        // Apply pixelated rendering for sharper text
        if (typeof Graphics !== 'undefined' && Graphics._renderer && Graphics._renderer.view) {
            Graphics._renderer.view.style.imageRendering = 'pixelated';
            Graphics._renderer.view.style.imageRendering = '-moz-crisp-edges';
            Graphics._renderer.view.style.imageRendering = 'crisp-edges';
            
            // Also disable anti-aliasing on the canvas context if possible
            var ctx = Graphics._renderer.view.getContext('2d');
            if (ctx) {
                ctx.imageSmoothingEnabled = false;
                ctx.imageSmoothingQuality = 'low';
            }
        }
        
        // Hook into Scene_Boot to ensure settings persist
        if (typeof Scene_Boot !== 'undefined' && Scene_Boot.prototype.start) {
            var _sceneBootStart = Scene_Boot.prototype.start;
            Scene_Boot.prototype.start = function() {
                _sceneBootStart.call(this);
                // Re-apply after boot in case renderer was recreated
                if (Graphics._renderer && Graphics._renderer.view) {
                    Graphics._renderer.view.style.imageRendering = 'pixelated';
                    Graphics._renderer.view.style.imageRendering = '-moz-crisp-edges';
                    Graphics._renderer.view.style.imageRendering = 'crisp-edges';
                }
            };
        }
    }

    // Apply settings when library loads
    if (typeof document !== 'undefined') {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', _applyPixelSettings);
        } else {
            _applyPixelSettings();
        }
    }

    // Also try to apply immediately (for RM MV environment)
    _applyPixelSettings();
})();

// ═══ ui/core/input-blocker.js ═══
/**
 * L2_InputBlocker - Prevents UI events from propagating to the game engine.
 * 
 * This module intercepts game-level input when UI components are visible,
 * preventing the player character from moving when clicking on UI elements.
 * UI components continue to receive events normally.
 */
(function () {
    'use strict';

    var _registeredUI = [];
    var _isHooked = false;

    function L2_InputBlocker() {
        throw new Error('L2_InputBlocker is a static class');
    }

    /**
     * Register a UI component to block input events.
     * @param {L2_Base} uiComponent - The UI component to register
     */
    L2_InputBlocker.register = function (uiComponent) {
        if (!uiComponent || _registeredUI.indexOf(uiComponent) >= 0) return;
        _registeredUI.push(uiComponent);
        _ensureHooked();
    };

    /**
     * Unregister a UI component.
     * @param {L2_Base} uiComponent - The UI component to unregister
     */
    L2_InputBlocker.unregister = function (uiComponent) {
        var idx = _registeredUI.indexOf(uiComponent);
        if (idx >= 0) {
            _registeredUI.splice(idx, 1);
        }
    };

    /**
     * Check if any registered UI is visible and blocking at the given coordinates.
     * @param {number} x - Screen X coordinate
     * @param {number} y - Screen Y coordinate
     * @returns {boolean} True if input should be blocked
     */
    L2_InputBlocker.isBlocking = function (x, y) {
        for (var i = _registeredUI.length - 1; i >= 0; i--) {
            var ui = _registeredUI[i];
            if (ui && ui.visible && !ui._destroyed && ui.isInside && ui.isInside(x, y)) {
                return true;
            }
        }
        return false;
    };

    /**
     * Check if any UI is currently visible (regardless of mouse position).
     * @returns {boolean}
     */
    L2_InputBlocker.hasVisibleUI = function () {
        for (var i = 0; i < _registeredUI.length; i++) {
            var ui = _registeredUI[i];
            if (ui && ui.visible && !ui._destroyed) {
                return true;
            }
        }
        return false;
    };

    /**
     * Clear all registered UI components.
     */
    L2_InputBlocker.clear = function () {
        _registeredUI = [];
    };

    /**
     * Hook game methods to intercept events.
     * Only blocks game actions, does not interfere with UI.
     * @private
     */
    function _ensureHooked() {
        if (_isHooked) return;
        _isHooked = true;

        // Wait for RMMV to initialize
        if (typeof TouchInput === 'undefined' || typeof Scene_Map === 'undefined') {
            setTimeout(_ensureHooked, 100);
            return;
        }

        // Hook Scene_Map.prototype.processMapTouch
        // This is where the game processes clicks on the map
        if (Scene_Map.prototype.processMapTouch) {
            var _processMapTouch = Scene_Map.prototype.processMapTouch;
            Scene_Map.prototype.processMapTouch = function () {
                // Only block if clicking on UI
                if (TouchInput.isTriggered() && L2_InputBlocker.isBlocking(TouchInput.x, TouchInput.y)) {
                    // Consume the trigger but don't process map touch
                    return;
                }
                _processMapTouch.call(this);
            };
        }

        // Hook Game_Player.prototype.moveByInput
        // This is where player movement from input is processed
        if (Game_Player.prototype.moveByInput) {
            var _moveByInput = Game_Player.prototype.moveByInput;
            Game_Player.prototype.moveByInput = function () {
                // Check if there's a pending click on UI - only if game is initialized
                if (typeof TouchInput !== 'undefined' && TouchInput && 
                    TouchInput.isTriggered() && L2_InputBlocker.isBlocking(TouchInput.x, TouchInput.y)) {
                    // Don't move player
                    return;
                }
                _moveByInput.call(this);
            };
        }

        // Hook Game_Temp.prototype.setDestination
        // This sets the target position for player movement
        if (Game_Temp.prototype.setDestination) {
            var _setDestination = Game_Temp.prototype.setDestination;
            Game_Temp.prototype.setDestination = function (x, y) {
                // Check if clicking on UI - only if game is fully initialized
                if (typeof $gameMap !== 'undefined' && $gameMap && 
                    typeof $gamePlayer !== 'undefined' && $gamePlayer &&
                    typeof TouchInput !== 'undefined' && TouchInput.x !== undefined) {
                    if (L2_InputBlocker.isBlocking(TouchInput.x, TouchInput.y)) {
                        // Don't set destination if clicking on UI
                        return;
                    }
                }
                _setDestination.call(this, x, y);
            };
        }
    }

    window.L2_InputBlocker = L2_InputBlocker;
})();

// ═══ ui/core/base.js ═══
/**
 * L2_Base - Base class for all L2 UI components.
 * Extends Window_Base with L2 theming and common utilities.
 * 
 * Performance features:
 * - Layered rendering (static/dynamic layers)
 * - Dirty region tracking
 * - Cached property access
 */
(function () {
    'use strict';

    // Global cache for expensive calculations
    var _colorCache = {};
    var _textWidthCache = {};
    var _cacheLimit = 1000;

    function L2_Base() { this.initialize.apply(this, arguments); }
    L2_Base.prototype = Object.create(Window_Base.prototype);
    L2_Base.prototype.constructor = L2_Base;

    L2_Base.prototype.initialize = function (x, y, w, h) {
        Window_Base.prototype.initialize.call(this, x, y, w, h);
        this.opacity = 0;       // hide RMMV windowskin
        this.backOpacity = 0;
        this._dirty = true;     // 脏检查标志
        this._dirtyLayers = { bg: true, content: true }; // 分层脏标记
        this._destroyed = false;
        this._cacheKey = null;  // 缓存键
        this._lastFrameUpdated = 0; // 帧率控制
        this._lastVisibleState = false; // 用于输入拦截器状态跟踪
        
        // Auto-register with input blocker if initially visible
        this._updateInputBlocker();
        this._updateInterval = 1;   // 默认每帧更新
    };

    /** Mark component as needing redraw. */
    L2_Base.prototype.markDirty = function (layer) {
        this._dirty = true;
        if (layer) {
            this._dirtyLayers[layer] = true;
        } else {
            this._dirtyLayers.bg = true;
            this._dirtyLayers.content = true;
        }
    };

    /** Mark specific layer as clean after render. */
    L2_Base.prototype.markLayerClean = function (layer) {
        if (layer) {
            this._dirtyLayers[layer] = false;
        }
        // 如果所有层都干净了，整体标记为干净
        if (!this._dirtyLayers.bg && !this._dirtyLayers.content) {
            this._dirty = false;
        }
    };

    /** Check if component needs redraw. */
    L2_Base.prototype.isDirty = function () {
        return this._dirty;
    };

    /** Check if specific layer needs redraw. */
    L2_Base.prototype.isLayerDirty = function (layer) {
        return this._dirtyLayers[layer] !== false;
    };

    /** Set update interval for frame skipping (performance control). */
    L2_Base.prototype.setUpdateInterval = function (frames) {
        this._updateInterval = Math.max(1, frames);
    };

    /** Override update to support dirty checking and frame skipping. */
    var _baseUpdate = L2_Base.prototype.update;
    L2_Base.prototype.update = function () {
        _baseUpdate.call(this);
        
        // 更新输入拦截器状态
        this._updateInputBlocker();
        
        // 帧跳过优化
        this._lastFrameUpdated++;
        if (this._lastFrameUpdated < this._updateInterval) {
            return;
        }
        this._lastFrameUpdated = 0;
        
        if (this._dirty) {
            this.refresh();
            this._dirtyLayers.bg = false;
            this._dirtyLayers.content = false;
            this._dirty = false;
        }
    };

    /** Static method to clear global caches. */
    L2_Base.clearCaches = function () {
        _colorCache = {};
        _textWidthCache = {};
    };

    /** Get cached color value. */
    L2_Base.getCachedColor = function (key, calculator) {
        if (_colorCache[key] !== undefined) {
            return _colorCache[key];
        }
        var value = calculator();
        // 限制缓存大小
        if (Object.keys(_colorCache).length > _cacheLimit) {
            _colorCache = {};
        }
        _colorCache[key] = value;
        return value;
    };

    /**
     * Auto-register/unregister from input blocker based on visibility.
     * Called automatically in update method.
     */
    L2_Base.prototype._updateInputBlocker = function () {
        if (typeof L2_InputBlocker === 'undefined') return;
        
        var wasVisible = this._lastVisibleState;
        var isVisible = this.visible && !this._destroyed;
        
        if (wasVisible !== isVisible) {
            this._lastVisibleState = isVisible;
            if (isVisible) {
                L2_InputBlocker.register(this);
            } else {
                L2_InputBlocker.unregister(this);
            }
        }
    };

    /**
     * Destroy the component and cleanup resources.
     * Override in subclasses for specific cleanup.
     */
    L2_Base.prototype.destroy = function () {
        if (this._destroyed) return;
        this._destroyed = true;
        
        // Unregister from input blocker
        if (typeof L2_InputBlocker !== 'undefined') {
            L2_InputBlocker.unregister(this);
        }
        
        // Remove from parent
        if (this.parent) {
            this.parent.removeChild(this);
        }
        
        // Cleanup children
        if (this.children) {
            for (var i = this.children.length - 1; i >= 0; i--) {
                var child = this.children[i];
                if (child && child.destroy) {
                    child.destroy();
                }
            }
            this.children = [];
        }
        
        // Cleanup bitmap
        if (this.contents) {
            this.contents = null;
        }
        
        // Remove event listeners if any
        this._onChange = null;
        this._onClick = null;
        this._onSelect = null;
        this._onClose = null;
        this._onSubmit = null;
    };

    L2_Base.prototype.standardPadding = function () { return L2_Theme.padding; };

    /** Hit test: is (mx, my) inside this component's bounds? */
    L2_Base.prototype.isInside = function (mx, my) {
        return mx >= this.x && mx <= this.x + this.width &&
               my >= this.y && my <= this.y + this.height;
    };

    /** Convert screen coords to local content coords. */
    L2_Base.prototype.toLocal = function (mx, my) {
        return { x: mx - this.x - this.padding, y: my - this.y - this.padding };
    };

    /** Shorthand for contents bitmap. */
    L2_Base.prototype.bmp = function () { return this.contents; };

    /** Shorthand for contents width. */
    L2_Base.prototype.cw = function () { return this.contentsWidth(); };

    /** Shorthand for contents height. */
    L2_Base.prototype.ch = function () { return this.contentsHeight(); };

    /**
     * Batch update multiple components efficiently.
     * Call this instead of individual updates when possible.
     */
    L2_Base.batchUpdate = function (components) {
        var mx = TouchInput.x;
        var my = TouchInput.y;
        var triggered = TouchInput.isTriggered();
        var pressed = TouchInput.isPressed();
        
        for (var i = 0; i < components.length; i++) {
            var comp = components[i];
            if (!comp || !comp.visible || comp._destroyed) continue;
            
            // 批量检测鼠标状态
            if (comp._updateHoverState) {
                var inside = comp.isInside(mx, my);
                comp._updateHoverState(inside, triggered, pressed);
            }
            
            // 调用标准 update
            if (comp.update) {
                comp.update();
            }
        }
    };

    /**
     * Fast hit test without creating objects.
     * Returns -1 if not inside, or the component index if inside.
     */
    L2_Base.fastHitTest = function (components, mx, my) {
        for (var i = components.length - 1; i >= 0; i--) {
            var comp = components[i];
            if (comp && comp.visible && !comp._destroyed &&
                mx >= comp.x && mx <= comp.x + comp.width &&
                my >= comp.y && my <= comp.y + comp.height) {
                return i;
            }
        }
        return -1;
    };

    window.L2_Base = L2_Base;
})();

// ═══ ui/layout/divider.js ═══
/**
 * L2_Divider - Horizontal or vertical dividing line.
 */
(function () {
    'use strict';

    function L2_Divider() { this.initialize.apply(this, arguments); }
    L2_Divider.prototype = Object.create(L2_Base.prototype);
    L2_Divider.prototype.constructor = L2_Divider;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} length
     * @param {object} [opts] - { vertical, color, text }
     */
    L2_Divider.prototype.initialize = function (x, y, length, opts) {
        opts = opts || {};
        var vertical = opts.vertical || false;
        var w = vertical ? 8 : length;
        var h = vertical ? length : 8;
        L2_Base.prototype.initialize.call(this, x, y, w + 16, h + 16);
        this._vertical = vertical;
        this._lineColor = opts.color || L2_Theme.divider;
        this._text = opts.text || '';
        this._length = length;
        this.refresh();
    };

    L2_Divider.prototype.standardPadding = function () { return 0; };

    L2_Divider.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        if (this._vertical) {
            L2_Theme.drawLine(c, cw / 2, 0, cw / 2, ch, this._lineColor);
        } else if (this._text) {
            var tw = L2_Theme.measureText(c, this._text, L2_Theme.fontSmall);
            var cx = cw / 2;
            var half = tw / 2 + 8;
            L2_Theme.drawLine(c, 0, ch / 2, cx - half, ch / 2, this._lineColor);
            L2_Theme.drawLine(c, cx + half, ch / 2, cw, ch / 2, this._lineColor);
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textGray;
            c.drawText(this._text, 0, 0, cw, ch, 'center');
        } else {
            L2_Theme.drawLine(c, 0, ch / 2, cw, ch / 2, this._lineColor);
        }
    };

    window.L2_Divider = L2_Divider;
})();

// ═══ ui/layout/grid.js ═══
/**
 * L2_Grid - Grid layout container for arranging children in rows/columns.
 * Does not render itself - positions children on refresh.
 */
(function () {
    'use strict';

    function L2_Grid() { this.initialize.apply(this, arguments); }
    L2_Grid.prototype = Object.create(L2_Base.prototype);
    L2_Grid.prototype.constructor = L2_Grid;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {number} h
     * @param {object} [opts] - { cols, rowGap, colGap }
     */
    L2_Grid.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._cols = opts.cols || 1;
        this._rowGap = opts.rowGap !== undefined ? opts.rowGap : L2_Theme.defaultGap;
        this._colGap = opts.colGap !== undefined ? opts.colGap : L2_Theme.defaultGap;
        this._managed = [];
    };

    L2_Grid.prototype.standardPadding = function () { return 0; };

    /** Add a component to the grid. */
    L2_Grid.prototype.addItem = function (component) {
        this._managed.push(component);
        this.addChild(component);
        this.layoutItems();
    };

    /** Remove all grid items. */
    L2_Grid.prototype.clearItems = function () {
        var self = this;
        this._managed.forEach(function (c) {
            if (c.parent === self) self.removeChild(c);
        });
        this._managed = [];
    };

    /** Recalculate positions of all managed children. */
    L2_Grid.prototype.layoutItems = function () {
        var cols = Math.max(1, this._cols || 1);
        var cw = this.cw();
        var cellW = (cw - (cols - 1) * this._colGap) / cols;

        for (var i = 0; i < this._managed.length; i++) {
            var col = i % cols;
            var row = Math.floor(i / cols);
            var cx = col * (cellW + this._colGap);
            var cy = row * (this._managed[i].height + this._rowGap);
            this._managed[i].x = cx;
            this._managed[i].y = cy;
        }
    };

    /** Get all managed items. */
    L2_Grid.prototype.getItems = function () { return this._managed; };

    L2_Grid.prototype.refresh = function () {
        this.bmp().clear();
    };

    window.L2_Grid = L2_Grid;
})();

// ═══ ui/layout/layout.js ═══
/**
 * L2_Layout - Flex-like layout container (horizontal/vertical).
 * Positions children sequentially with gap spacing.
 */
(function () {
    'use strict';

    function L2_Layout() { this.initialize.apply(this, arguments); }
    L2_Layout.prototype = Object.create(L2_Base.prototype);
    L2_Layout.prototype.constructor = L2_Layout;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {number} h
     * @param {object} [opts] - { direction:'horizontal'|'vertical', gap, align:'start'|'center'|'end' }
     */
    L2_Layout.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._direction = opts.direction || 'horizontal';
        this._gap = opts.gap !== undefined ? opts.gap : L2_Theme.defaultGap;
        this._align = opts.align || 'start';
        this._managed = [];
    };

    L2_Layout.prototype.standardPadding = function () { return 0; };

    L2_Layout.prototype.addItem = function (component) {
        this._managed.push(component);
        this.addChild(component);
        this.layoutItems();
    };

    L2_Layout.prototype.clearItems = function () {
        var self = this;
        this._managed.forEach(function (c) {
            if (c.parent === self) self.removeChild(c);
        });
        this._managed = [];
    };

    L2_Layout.prototype.layoutItems = function () {
        var pos = 0;
        var isH = this._direction === 'horizontal';
        var containerSize = isH ? this.ch() : this.cw();

        for (var i = 0; i < this._managed.length; i++) {
            var item = this._managed[i];
            var itemSize = isH ? item.height : item.width;
            var crossPos = 0;

            if (this._align === 'center') {
                crossPos = (containerSize - itemSize) / 2;
            } else if (this._align === 'end') {
                crossPos = containerSize - itemSize;
            }

            if (isH) {
                item.x = pos;
                item.y = crossPos;
            } else {
                item.x = crossPos;
                item.y = pos;
            }
            pos += (isH ? item.width : item.height) + this._gap;
        }
    };

    L2_Layout.prototype.refresh = function () { this.bmp().clear(); };

    window.L2_Layout = L2_Layout;
})();

// ═══ ui/layout/space.js ═══
/**
 * L2_Space - Invisible spacer for layout purposes.
 */
(function () {
    'use strict';

    function L2_Space() { this.initialize.apply(this, arguments); }
    L2_Space.prototype = Object.create(L2_Base.prototype);
    L2_Space.prototype.constructor = L2_Space;

    L2_Space.prototype.initialize = function (w, h) {
        L2_Base.prototype.initialize.call(this, 0, 0, w || 8, h || 8);
    };

    L2_Space.prototype.standardPadding = function () { return 0; };
    L2_Space.prototype.refresh = function () { this.bmp().clear(); };

    window.L2_Space = L2_Space;
})();

// ═══ ui/base/button.js ═══
/**
 * L2_Button - Clickable button with hover/pressed states.
 */
(function () {
    'use strict';

    function L2_Button() { this.initialize.apply(this, arguments); }
    L2_Button.prototype = Object.create(L2_Base.prototype);
    L2_Button.prototype.constructor = L2_Button;

    /**
     * Supports two signatures:
     *   new L2_Button(x, y, label, opts)           — auto-size
     *   new L2_Button(x, y, w, h, label, opts)     — explicit size
     */
    L2_Button.prototype.initialize = function (x, y, wOrLabel, hOrOpts, label, opts) {
        if (typeof wOrLabel === 'string') {
            // Auto-size: (x, y, label, opts)
            label = wOrLabel;
            opts = hOrOpts || {};
            var autoW = Math.max(label.length * 12 + 20 + (opts.icon >= 0 ? 28 : 0), 50);
            L2_Base.prototype.initialize.call(this, x, y, autoW + 4, 28 + 4);
        } else {
            // Explicit: (x, y, w, h, label, opts)
            opts = opts || {};
            L2_Base.prototype.initialize.call(this, x, y, wOrLabel, hOrOpts);
        }
        this._label = label || '';
        this._onClick = opts.onClick || null;
        this._iconIndex = opts.icon !== undefined ? opts.icon : -1;
        this._type = opts.type || 'default';
        this._enabled = opts.enabled !== false;
        this._hover = false;
        this._pressed = false;
        this.refresh();
    };

    L2_Button.prototype.standardPadding = function () { return 2; };

    L2_Button.prototype.setLabel = function (t) { this._label = t; this.markDirty(); };
    L2_Button.prototype.setEnabled = function (b) { this._enabled = b; this.markDirty(); };
    L2_Button.prototype.setOnClick = function (fn) { this._onClick = fn; };

    L2_Button.prototype._getColors = function () {
        var bg, border, text;
        switch (this._type) {
            case 'primary':
                bg = this._pressed ? '#0D2A60' : (this._hover ? '#1A3A70' : '#142A55');
                border = this._hover ? '#4488DD' : '#335599';
                text = L2_Theme.textWhite;
                break;
            case 'success':
                bg = this._pressed ? '#0D2A15' : (this._hover ? '#1A3A25' : '#142A1A');
                border = this._hover ? '#44DD88' : '#338855';
                text = L2_Theme.textGreen;
                break;
            case 'danger':
                bg = this._pressed ? '#2A0D0D' : (this._hover ? '#3A1A1A' : '#2A1414');
                border = this._hover ? '#DD4444' : '#993333';
                text = L2_Theme.textRed;
                break;
            case 'text':
                bg = this._hover ? L2_Theme.highlight : 'rgba(0,0,0,0)';
                border = 'rgba(0,0,0,0)';
                text = this._hover ? L2_Theme.textWhite : L2_Theme.textGray;
                break;
            default:
                bg = this._pressed ? L2_Theme.bgButtonPress :
                     (this._hover ? L2_Theme.bgButtonHover : L2_Theme.bgButton);
                border = this._hover ? L2_Theme.borderGold : L2_Theme.borderDark;
                text = L2_Theme.textWhite;
        }
        if (!this._enabled) {
            bg = '#111118';
            border = '#1A1A22';
            text = L2_Theme.textDim;
        }
        return { bg: bg, border: border, text: text };
    };

    L2_Button.prototype.refresh = function () {
        var c = this.bmp();
        var cw = this.cw(), ch = this.ch();
        var colors = this._getColors();

        // 只有背景层脏时才重绘背景
        if (this.isLayerDirty('bg')) {
            c.clear();
            if (this._type !== 'text') {
                L2_Theme.fillRoundRect(c, 0, 0, cw, ch, L2_Theme.cornerRadius, colors.bg);
                L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, L2_Theme.cornerRadius, colors.border);
            }
            this.markLayerClean('bg');
        }

        // 内容层总是重绘（因为文字可能变化）
        if (this.isLayerDirty('content')) {
            // 如果背景不是透明的，需要清除内容区域
            if (this._type === 'text') {
                c.clear();
            }
            
            var textX = 0, textW = cw;
            // Draw icon if present
            if (this._iconIndex >= 0) {
                var iconSize = 20;
                var iconX = 6;
                var iconY = (ch - iconSize) / 2;
                // Draw from IconSet
                if (ImageManager && ImageManager.loadSystem) {
                    var iconSet = ImageManager.loadSystem('IconSet');
                    if (iconSet && iconSet.isReady()) {
                        var pw = Window_Base._iconWidth || 32;
                        var ph = Window_Base._iconHeight || 32;
                        var sx = (this._iconIndex % 16) * pw;
                        var sy = Math.floor(this._iconIndex / 16) * ph;
                        c.blt(iconSet, sx, sy, pw, ph, iconX, iconY, iconSize, iconSize);
                    }
                }
                textX = iconX + iconSize + 4;
                textW = cw - textX - 4;
            }

            // 使用锐化文字渲染
            var ctx = c._context;
            if (ctx) {
                L2_Theme.configureTextContext(ctx, L2_Theme.fontNormal, colors.text);
                var align = this._iconIndex >= 0 ? 'left' : 'center';
                L2_Theme.drawTextSharp(c, this._label, textX, 0, textW, ch, align);
            } else {
                c.fontSize = L2_Theme.fontNormal;
                c.textColor = colors.text;
                c.drawText(this._label, textX, 0, textW, ch, this._iconIndex >= 0 ? 'left' : 'center');
            }
            this.markLayerClean('content');
        }
    };

    L2_Button.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var mx = TouchInput.x, my = TouchInput.y;
        var inside = this.isInside(mx, my);
        var wasHover = this._hover;
        var wasPressed = this._pressed;
        this._hover = inside && this._enabled;

        if (this._enabled && inside && TouchInput.isTriggered()) {
            this._pressed = true;
        }
        if (this._pressed && !TouchInput.isPressed()) {
            this._pressed = false;
            if (inside && this._onClick) this._onClick();
        }
        if (!TouchInput.isPressed()) this._pressed = false;

        // 只有当状态真正改变时才标记为脏
        if (wasHover !== this._hover || wasPressed !== this._pressed) {
            this.markDirty('bg');
            this.markDirty('content');
        }
    };

    /**
     * Optimized hover state update for batch processing.
     * @private
     */
    L2_Button.prototype._updateHoverState = function (inside, triggered, pressed) {
        var wasHover = this._hover;
        var wasPressed = this._pressed;
        this._hover = inside && this._enabled;
        
        if (this._enabled && inside && triggered) {
            this._pressed = true;
        }
        if (this._pressed && !pressed) {
            this._pressed = false;
            if (inside && this._onClick) this._onClick();
        }
        if (!pressed) this._pressed = false;
        
        if (wasHover !== this._hover || wasPressed !== this._pressed) {
            this.markDirty('bg');
            this.markDirty('content');
        }
    };

    window.L2_Button = L2_Button;
})();

// ═══ ui/base/icon.js ═══
/**
 * L2_Icon - Renders an icon from the RMMV IconSet.
 */
(function () {
    'use strict';

    function L2_Icon() { this.initialize.apply(this, arguments); }
    L2_Icon.prototype = Object.create(L2_Base.prototype);
    L2_Icon.prototype.constructor = L2_Icon;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} iconIndex
     * @param {object} [opts] - { size, onClick }
     */
    L2_Icon.prototype.initialize = function (x, y, iconIndex, opts) {
        opts = opts || {};
        var size = opts.size || L2_Theme.iconSize;
        L2_Base.prototype.initialize.call(this, x, y, size + 4, size + 4);
        this._iconIndex = iconIndex || 0;
        this._iconSize = size;
        this._onClick = opts.onClick || null;
        this.refresh();
    };

    L2_Icon.prototype.standardPadding = function () { return 2; };

    L2_Icon.prototype.setIcon = function (index) {
        this._iconIndex = index;
        this.markDirty();
    };

    L2_Icon.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        if (this._iconIndex < 0) return;

        if (ImageManager && ImageManager.loadSystem) {
            var iconSet = ImageManager.loadSystem('IconSet');
            if (iconSet && iconSet.isReady()) {
                var pw = Window_Base._iconWidth || 32;
                var ph = Window_Base._iconHeight || 32;
                var sx = (this._iconIndex % 16) * pw;
                var sy = Math.floor(this._iconIndex / 16) * ph;
                c.blt(iconSet, sx, sy, pw, ph, 0, 0, this._iconSize, this._iconSize);
            }
        }
    };

    L2_Icon.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible || !this._onClick) return;
        if (TouchInput.isTriggered() && this.isInside(TouchInput.x, TouchInput.y)) {
            this._onClick(this._iconIndex);
        }
    };

    window.L2_Icon = L2_Icon;
})();

// ═══ ui/base/link.js ═══
/**
 * L2_Link - Clickable text link with hover underline.
 */
(function () {
    'use strict';

    function L2_Link() { this.initialize.apply(this, arguments); }
    L2_Link.prototype = Object.create(L2_Base.prototype);
    L2_Link.prototype.constructor = L2_Link;

    /**
     * @param {number} x
     * @param {number} y
     * @param {string} text
     * @param {object} [opts] - { onClick, color, hoverColor }
     */
    L2_Link.prototype.initialize = function (x, y, text, opts) {
        opts = opts || {};
        var w = Math.max((text || '').length * 10 + 8, 40);
        L2_Base.prototype.initialize.call(this, x, y, w, 22);
        this._text = text || '';
        this._onClick = opts.onClick || null;
        this._color = opts.color || L2_Theme.textLink;
        this._hoverColor = opts.hoverColor || L2_Theme.textLinkHover;
        this._hover = false;
        this.refresh();
    };

    L2_Link.prototype.standardPadding = function () { return 2; };

    L2_Link.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = this._hover ? this._hoverColor : this._color;
        c.drawText(this._text, 0, 0, cw, ch, 'left');
        if (this._hover) {
            var tw = L2_Theme.measureText(c, this._text, L2_Theme.fontNormal);
            L2_Theme.drawLine(c, 0, ch - 2, Math.min(tw, cw), ch - 2,
                this._hoverColor);
        }
    };

    L2_Link.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var wasHover = this._hover;
        this._hover = this.isInside(TouchInput.x, TouchInput.y);
        if (this._hover !== wasHover) this.markDirty();
        if (this._hover && TouchInput.isTriggered() && this._onClick) {
            this._onClick();
        }
    };

    window.L2_Link = L2_Link;
})();

// ═══ ui/base/typography.js ═══
/**
 * L2_Typography - Text display with heading levels (H1-H3), paragraph, caption.
 */
(function () {
    'use strict';

    function L2_Typography() { this.initialize.apply(this, arguments); }
    L2_Typography.prototype = Object.create(L2_Base.prototype);
    L2_Typography.prototype.constructor = L2_Typography;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { text, level:'h1'|'h2'|'h3'|'body'|'caption', color, align }
     */
    L2_Typography.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        this._level = opts.level || 'body';
        var h = L2_Typography._heightForLevel(this._level);
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this._text = opts.text || '';
        this._textColor = opts.color || null;
        this._align = opts.align || 'left';
        this.refresh();
    };

    L2_Typography.prototype.standardPadding = function () { return 2; };

    L2_Typography._heightForLevel = function (level) {
        switch (level) {
            case 'h1': return L2_Theme.fontH1 + 12;
            case 'h2': return L2_Theme.fontH2 + 10;
            case 'h3': return L2_Theme.fontH3 + 8;
            case 'caption': return L2_Theme.fontTiny + 8;
            default: return L2_Theme.fontNormal + 8;
        }
    };

    L2_Typography.prototype.setText = function (t) {
        this._text = t;
        this.markDirty();
    };

    L2_Typography.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        var fontSize, color;
        switch (this._level) {
            case 'h1':
                fontSize = L2_Theme.fontH1;
                color = this._textColor || L2_Theme.textWhite;
                break;
            case 'h2':
                fontSize = L2_Theme.fontH2;
                color = this._textColor || L2_Theme.textWhite;
                break;
            case 'h3':
                fontSize = L2_Theme.fontH3;
                color = this._textColor || L2_Theme.textTitle;
                break;
            case 'caption':
                fontSize = L2_Theme.fontTiny;
                color = this._textColor || L2_Theme.textDim;
                break;
            default:
                fontSize = L2_Theme.fontNormal;
                color = this._textColor || L2_Theme.textGray;
        }

        // 使用锐化文字渲染
        var ctx = c._context;
        if (ctx) {
            L2_Theme.configureTextContext(ctx, fontSize, color);
            L2_Theme.drawTextSharp(c, this._text, 0, 0, cw, ch, this._align);
        } else {
            // 降级到默认渲染
            c.fontSize = fontSize;
            c.textColor = color;
            c.drawText(this._text, 0, 0, cw, ch, this._align);
        }
    };

    window.L2_Typography = L2_Typography;
})();

// ═══ ui/navigation/tabs.js ═══
/**
 * L2_Tabs - Tab bar for switching content panels.
 */
(function () {
    'use strict';

    function L2_Tabs() { this.initialize.apply(this, arguments); }
    L2_Tabs.prototype = Object.create(L2_Base.prototype);
    L2_Tabs.prototype.constructor = L2_Tabs;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { tabs, onChange, activeIndex }
     */
    L2_Tabs.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        L2_Base.prototype.initialize.call(this, x, y, w, 28 + 16);
        this._tabs = opts.tabs || [];
        this._activeTab = opts.activeIndex || 0;
        this._hoverTab = -1;
        this._onChange = opts.onChange || null;
        this.refresh();
    };

    L2_Tabs.prototype.standardPadding = function () { return 0; };

    L2_Tabs.prototype.getActiveTab = function () { return this._activeTab; };
    L2_Tabs.prototype.getActiveLabel = function () { return this._tabs[this._activeTab]; };

    L2_Tabs.prototype.setActiveTab = function (idx) {
        if (idx === this._activeTab || idx < 0 || idx >= this._tabs.length || !this._tabs.length) return;
        this._activeTab = idx;
        if (this._onChange) this._onChange(idx, this._tabs[idx]);
        this.markDirty();
    };

    L2_Tabs.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var tw = Math.floor(cw / Math.max(this._tabs.length, 1));
        var self = this;

        c.fillRect(0, 0, cw, ch, L2_Theme.bgPanel);

        this._tabs.forEach(function (label, i) {
            var tx = i * tw;
            var active = i === self._activeTab;
            var hover = i === self._hoverTab;

            if (active) {
                c.fillRect(tx, 0, tw, ch, '#1E1E38');
                c.fillRect(tx, ch - 2, tw, 2, L2_Theme.textGold);
            } else if (hover) {
                c.fillRect(tx, 0, tw, ch, L2_Theme.highlight);
            }

            c.fontSize = L2_Theme.fontNormal;
            c.textColor = active ? L2_Theme.textGold : L2_Theme.textGray;
            c.drawText(label, tx, 0, tw, ch, 'center');

            if (i > 0) c.fillRect(tx, 4, 1, ch - 8, L2_Theme.borderDark);
        });
    };

    L2_Tabs.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var mx = TouchInput.x - this.x;
        var my = TouchInput.y - this.y;
        var tw = Math.floor(this.cw() / Math.max(this._tabs.length, 1));
        var inside = mx >= 0 && mx < this.width && my >= 0 && my < this.height;
        var oldHover = this._hoverTab;
        var tabIdx = -1;
        if (inside && this._tabs.length > 0) {
            tabIdx = Math.floor(mx / tw);
            tabIdx = Math.max(0, Math.min(tabIdx, this._tabs.length - 1));
        }
        this._hoverTab = tabIdx;
        if (this._hoverTab !== oldHover) this.markDirty();
        if (inside && TouchInput.isTriggered() && tabIdx >= 0) {
            this.setActiveTab(tabIdx);
        }
    };

    window.L2_Tabs = L2_Tabs;
})();

// ═══ ui/navigation/menu.js ═══
/**
 * L2_Menu - Vertical navigation menu with selectable items.
 */
(function () {
    'use strict';

    function L2_Menu() { this.initialize.apply(this, arguments); }
    L2_Menu.prototype = Object.create(L2_Base.prototype);
    L2_Menu.prototype.constructor = L2_Menu;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { items: [{label, icon, action}] or string[], itemHeight, activeIndex, maxHeight }
     */
    L2_Menu.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        var items = opts.items || [];
        // Support string[] shorthand
        if (items.length > 0 && typeof items[0] === 'string') {
            items = items.map(function (s) { return { label: s }; });
        }
        var itemH = opts.itemHeight || L2_Theme.defaultItemHeight;
        this._maxHeight = opts.maxHeight || 0; // 0 表示不限制高度
        var totalH = items.length * itemH + 8;
        var h = this._maxHeight > 0 ? Math.min(totalH, this._maxHeight) : totalH;
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this._items = items;
        this._itemHeight = itemH;
        this._activeIndex = opts.activeIndex !== undefined ? opts.activeIndex : -1;
        this._hoverIndex = -1;
        this._scrollY = 0;
        this.refresh();
    };

    L2_Menu.prototype.standardPadding = function () { return 4; };

    L2_Menu.prototype.setItems = function (items) {
        this._items = items || [];
        this._activeIndex = -1;
        this.markDirty();
    };

    L2_Menu.prototype.setActiveIndex = function (idx) {
        this._activeIndex = idx;
        this.markDirty();
    };

    L2_Menu.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        L2_Theme.drawPanelBg(c, 0, 0, cw, ch);

        var ih = this._itemHeight;
        var sbW = this._needsScrollbar() ? L2_Theme.scrollbarWidth : 0;
        var startIdx = Math.floor(this._scrollY / ih);
        var visCount = Math.ceil(ch / ih) + 1;

        for (var i = startIdx; i < Math.min(startIdx + visCount, this._items.length); i++) {
            var iy = i * ih + 4 - this._scrollY;
            if (iy + ih < 0 || iy > ch) continue;

            if (i === this._activeIndex) {
                c.fillRect(2, iy, cw - sbW - 4, ih, L2_Theme.selection);
                c.fillRect(2, iy, 3, ih, L2_Theme.textGold);
            } else if (i === this._hoverIndex) {
                c.fillRect(2, iy, cw - sbW - 4, ih, L2_Theme.highlight);
            }
            c.fontSize = L2_Theme.fontNormal;
            c.textColor = i === this._activeIndex ? L2_Theme.textGold : L2_Theme.textWhite;
            c.drawText(this._items[i].label || '', 12, iy + 4, cw - sbW - 24, ih - 8, 'left');
        }

        // 滚动条
        if (this._needsScrollbar()) {
            var totalH = this._items.length * ih;
            var trackH = ch - 4;
            var thumbH = Math.max(20, Math.round(trackH * (ch / totalH)));
            var thumbY = 2 + Math.round((trackH - thumbH) * (this._scrollY / (totalH - ch)));
            c.fillRect(cw - sbW, 0, sbW, ch, 'rgba(0,0,0,0.3)');
            L2_Theme.fillRoundRect(c, cw - sbW, thumbY, sbW, thumbH, 2, '#444466');
        }
    };

    L2_Menu.prototype._needsScrollbar = function () {
        if (this._maxHeight <= 0) return false;
        var totalH = this._items.length * this._itemHeight + 8;
        return totalH > this._maxHeight;
    };

    L2_Menu.prototype._getMaxScroll = function () {
        var totalH = this._items.length * this._itemHeight + 8;
        return Math.max(0, totalH - this.height);
    };

    L2_Menu.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw();
        var ih = this._itemHeight;
        var ch = this.ch();
        var sbW = this._needsScrollbar() ? 6 : 0;
        var inside = loc.x >= 0 && loc.x < cw - sbW && loc.y >= 0 && loc.y < ch;
        var oldHover = this._hoverIndex;
        this._hoverIndex = inside ? Math.floor((loc.y + this._scrollY - 4) / ih) : -1;
        if (this._hoverIndex >= this._items.length) this._hoverIndex = -1;
        if (this._hoverIndex !== oldHover) this.markDirty();

        // 滚轮滚动
        if (inside && TouchInput.wheelY && this._needsScrollbar()) {
            this._scrollY += TouchInput.wheelY > 0 ? ih : -ih;
            this._scrollY = Math.max(0, Math.min(this._scrollY, this._getMaxScroll()));
            this.markDirty();
        }

        if (inside && TouchInput.isTriggered() && this._hoverIndex >= 0) {
            this._activeIndex = this._hoverIndex;
            var item = this._items[this._hoverIndex];
            if (item && item.action) item.action(this._hoverIndex);
            this.markDirty();
        }
    };

    window.L2_Menu = L2_Menu;
})();

// ═══ ui/navigation/dropdown.js ═══
/**
 * L2_Dropdown - Dropdown menu triggered by clicking a button.
 */
(function () {
    'use strict';

    function L2_Dropdown() { this.initialize.apply(this, arguments); }
    L2_Dropdown.prototype = Object.create(L2_Base.prototype);
    L2_Dropdown.prototype.constructor = L2_Dropdown;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {string} label - trigger button label
     * @param {Array} options - [{label, action, color}]
     */
    L2_Dropdown.prototype.initialize = function (x, y, w, label, options) {
        L2_Base.prototype.initialize.call(this, x, y, w, L2_Theme.defaultBtnHeight + 4);
        this._label = label || '';
        this._options = options || [];
        this._open = false;
        this._hoverOption = -1;
        this._itemHeight = L2_Theme.defaultItemHeight;
        this.refresh();
    };

    L2_Dropdown.prototype.standardPadding = function () { return 2; };

    L2_Dropdown.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        // Trigger button
        L2_Theme.fillRoundRect(c, 0, 0, cw, 28, L2_Theme.cornerRadius, L2_Theme.bgButton);
        L2_Theme.strokeRoundRect(c, 0, 0, cw, 28, L2_Theme.cornerRadius, L2_Theme.borderDark);
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._label, 8, 4, cw - 28, 20, 'left');
        // Arrow
        c.textColor = L2_Theme.textGray;
        c.drawText(this._open ? '\u25B2' : '\u25BC', cw - 22, 4, 18, 20, 'center');

        // Dropdown list
        if (this._open) {
            var listH = this._options.length * this._itemHeight + 4;
            var listY = 30;
            L2_Theme.fillRoundRect(c, 0, listY, cw, listH, L2_Theme.cornerRadius, L2_Theme.bgPanel);
            L2_Theme.strokeRoundRect(c, 0, listY, cw, listH, L2_Theme.cornerRadius, L2_Theme.borderDark);

            var ih = this._itemHeight;
            var self = this;
            this._options.forEach(function (opt, i) {
                var iy = listY + 2 + i * ih;
                if (i === self._hoverOption) {
                    c.fillRect(2, iy, cw - 4, ih, L2_Theme.highlight);
                }
                c.fontSize = L2_Theme.fontNormal;
                c.textColor = opt.color || L2_Theme.textWhite;
                c.drawText(opt.label, 10, iy + 3, cw - 20, ih - 6, 'left');
            });
        }
    };

    L2_Dropdown.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw();
        var ih = this._itemHeight;

        if (this._open) {
            var listY = 30;
            var insideList = loc.x >= 0 && loc.x < cw &&
                            loc.y >= listY && loc.y < listY + this._options.length * ih + 4;
            var oldHover = this._hoverOption;
            this._hoverOption = insideList ? Math.floor((loc.y - listY - 2) / ih) : -1;
            if (this._options && this._hoverOption >= this._options.length) this._hoverOption = -1;
            if (this._hoverOption !== oldHover) this.markDirty();
        }

        if (TouchInput.isTriggered()) {
            var insideTrigger = loc.x >= 0 && loc.x < cw && loc.y >= 0 && loc.y < 28;
            if (insideTrigger) {
                this._open = !this._open;
                // Resize to fit dropdown
                var totalH = this._open ? 32 + this._options.length * ih + 8 : 32;
                this.move(this.x, this.y, this.width, totalH);
                this.createContents();
                this.refresh();
                return;
            }
            if (this._open && this._hoverOption >= 0) {
                var opt = this._options[this._hoverOption];
                this._open = false;
                this.move(this.x, this.y, this.width, 32);
                this.createContents();
                this.refresh();
                if (opt && opt.action) opt.action();
                return;
            }
            // Click outside closes
            if (this._open) {
                this._open = false;
                this.move(this.x, this.y, this.width, 32);
                this.createContents();
                this.refresh();
            }
        }
    };

    window.L2_Dropdown = L2_Dropdown;
})();

// ═══ ui/navigation/pagination.js ═══
/**
 * L2_Pagination - Page navigation with numbered buttons.
 */
(function () {
    'use strict';

    function L2_Pagination() { this.initialize.apply(this, arguments); }
    L2_Pagination.prototype = Object.create(L2_Base.prototype);
    L2_Pagination.prototype.constructor = L2_Pagination;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { total, pageSize, totalPages, current, currentPage, onChange }
     */
    L2_Pagination.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        var w = opts.width || 220;
        L2_Base.prototype.initialize.call(this, x, y, w, 32 + 4);
        if (opts.total && opts.pageSize) {
            this._totalPages = Math.ceil(opts.total / opts.pageSize);
        } else {
            this._totalPages = opts.totalPages || 1;
        }
        this._currentPage = opts.current || opts.currentPage || 1;
        this._onChange = opts.onChange || null;
        this._hoverBtn = -1; // -2=prev, -3=next, 0..n=page buttons
        this.refresh();
    };

    L2_Pagination.prototype.standardPadding = function () { return 2; };

    L2_Pagination.prototype.setPage = function (p) {
        this._currentPage = Math.max(1, Math.min(p, this._totalPages));
        if (this._onChange) this._onChange(this._currentPage);
        this.markDirty();
    };

    L2_Pagination.prototype.setTotalPages = function (n) {
        this._totalPages = Math.max(1, n);
        if (this._currentPage > this._totalPages) this._currentPage = this._totalPages;
        this.markDirty();
    };

    L2_Pagination.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var btnW = 28, btnH = 24, gap = 4;
        var cx = (cw - (this._totalPages + 2) * (btnW + gap)) / 2;

        // Prev button
        this._drawBtn(c, cx, 4, btnW, btnH, '\u25C0', this._hoverBtn === -2, this._currentPage > 1);
        cx += btnW + gap;

        // Page numbers
        var maxShow = Math.min(this._totalPages, Math.floor((cw - 80) / (btnW + gap)));
        var startP = Math.max(1, this._currentPage - Math.floor(maxShow / 2));
        var endP = Math.min(this._totalPages, startP + maxShow - 1);
        startP = Math.max(1, endP - maxShow + 1);

        for (var p = startP; p <= endP; p++) {
            var active = p === this._currentPage;
            var hover = this._hoverBtn === p;
            this._drawBtn(c, cx, 4, btnW, btnH, String(p), hover, true, active);
            cx += btnW + gap;
        }

        // Next button
        this._drawBtn(c, cx, 4, btnW, btnH, '\u25B6', this._hoverBtn === -3, this._currentPage < this._totalPages);
    };

    L2_Pagination.prototype._drawBtn = function (c, x, y, w, h, label, hover, enabled, active) {
        var bg = active ? '#1A2A55' : (hover && enabled ? L2_Theme.bgButtonHover : L2_Theme.bgButton);
        var border = active ? L2_Theme.borderActive : (hover && enabled ? L2_Theme.borderGold : L2_Theme.borderDark);
        L2_Theme.fillRoundRect(c, x, y, w, h, 2, bg);
        L2_Theme.strokeRoundRect(c, x, y, w, h, 2, border);
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = enabled ? (active ? L2_Theme.textGold : L2_Theme.textWhite) : L2_Theme.textDim;
        c.drawText(label, x, y + 2, w, h - 4, 'center');
    };

    L2_Pagination.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw();
        var btnW = 28, gap = 4;
        var maxShow = Math.min(this._totalPages, Math.floor((cw - 80) / (btnW + gap)));
        var startP = Math.max(1, this._currentPage - Math.floor(maxShow / 2));
        var endP = Math.min(this._totalPages, startP + maxShow - 1);
        startP = Math.max(1, endP - maxShow + 1);

        var cx = (cw - (endP - startP + 3) * (btnW + gap)) / 2;
        var oldHover = this._hoverBtn;
        this._hoverBtn = -1;

        // Prev
        if (loc.x >= cx && loc.x < cx + btnW && loc.y >= 4 && loc.y < 28) {
            this._hoverBtn = -2;
        }
        cx += btnW + gap;

        for (var p = startP; p <= endP; p++) {
            if (loc.x >= cx && loc.x < cx + btnW && loc.y >= 4 && loc.y < 28) {
                this._hoverBtn = p;
            }
            cx += btnW + gap;
        }

        // Next
        if (loc.x >= cx && loc.x < cx + btnW && loc.y >= 4 && loc.y < 28) {
            this._hoverBtn = -3;
        }

        if (this._hoverBtn !== oldHover) this.markDirty();

        if (TouchInput.isTriggered()) {
            if (this._hoverBtn === -2 && this._currentPage > 1) {
                this.setPage(this._currentPage - 1);
            } else if (this._hoverBtn === -3 && this._currentPage < this._totalPages) {
                this.setPage(this._currentPage + 1);
            } else if (this._hoverBtn > 0) {
                this.setPage(this._hoverBtn);
            }
        }
    };

    window.L2_Pagination = L2_Pagination;
})();

// ═══ ui/navigation/steps.js ═══
/**
 * L2_Steps - Step progress indicator (horizontal).
 */
(function () {
    'use strict';

    function L2_Steps() { this.initialize.apply(this, arguments); }
    L2_Steps.prototype = Object.create(L2_Base.prototype);
    L2_Steps.prototype.constructor = L2_Steps;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { steps, current, onChange }
     */
    L2_Steps.prototype.initialize = function (x, y, w, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, 48 + 4);
        opts = opts || {};
        this._steps = opts.steps || [];
        this._current = opts.current || 0;
        this._onChange = opts.onChange || null;
        this.refresh();
    };

    L2_Steps.prototype.standardPadding = function () { return 2; };

    L2_Steps.prototype.setCurrent = function (idx) {
        this._current = Math.max(0, Math.min(idx, this._steps.length - 1));
        if (this._onChange) this._onChange(this._current);
        this.markDirty();
    };

    L2_Steps.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var n = this._steps.length;
        if (n === 0) return;

        var stepW = cw / n;
        var dotR = 10;
        var dotY = 14;
        var self = this;

        this._steps.forEach(function (label, i) {
            var cx = stepW * i + stepW / 2;
            var done = i < self._current;
            var active = i === self._current;

            // Connector line
            if (i > 0) {
                var prevX = stepW * (i - 1) + stepW / 2;
                var lineColor = i <= self._current ? L2_Theme.textGold : L2_Theme.borderDark;
                L2_Theme.drawLine(c, prevX + dotR, dotY, cx - dotR, dotY, lineColor, 2);
            }

            // Dot
            var dotColor = done ? L2_Theme.textGold :
                          (active ? L2_Theme.textBlue : L2_Theme.borderDark);
            L2_Theme.drawCircle(c, cx, dotY, dotR, dotColor);

            // Number or check
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = done || active ? '#FFFFFF' : L2_Theme.textDim;
            if (done) {
                L2_Theme.drawCheck(c, cx - 6, dotY - 6, 12, '#FFFFFF');
            } else {
                c.drawText(String(i + 1), cx - dotR, dotY - 7, dotR * 2, 14, 'center');
            }

            // Label
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = active ? L2_Theme.textWhite : L2_Theme.textGray;
            c.drawText(label, cx - stepW / 2, dotY + dotR + 4, stepW, 16, 'center');
        });
    };

    window.L2_Steps = L2_Steps;
})();

// ═══ ui/navigation/breadcrumb.js ═══
/**
 * L2_Breadcrumb - Path breadcrumb navigation.
 */
(function () {
    'use strict';

    function L2_Breadcrumb() { this.initialize.apply(this, arguments); }
    L2_Breadcrumb.prototype = Object.create(L2_Base.prototype);
    L2_Breadcrumb.prototype.constructor = L2_Breadcrumb;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { items: [{label, action}] or string[], width }
     */
    L2_Breadcrumb.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        var items = opts.items || [];
        // Support string[] shorthand
        if (items.length > 0 && typeof items[0] === 'string') {
            items = items.map(function (s) { return { label: s }; });
        }
        var w = opts.width || 200;
        L2_Base.prototype.initialize.call(this, x, y, w, 24 + 4);
        this._items = items;
        this._hoverIndex = -1;
        this.refresh();
    };

    L2_Breadcrumb.prototype.standardPadding = function () { return 2; };

    L2_Breadcrumb.prototype.setItems = function (items) {
        this._items = items || [];
        this.markDirty();
    };

    L2_Breadcrumb.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var ch = this.ch();
        var x = 0;
        var self = this;

        this._items.forEach(function (item, i) {
            var isLast = i === self._items.length - 1;
            var isHover = i === self._hoverIndex;

            c.fontSize = L2_Theme.fontNormal;
            c.textColor = isLast ? L2_Theme.textWhite :
                          (isHover ? L2_Theme.textLinkHover : L2_Theme.textLink);
            var tw = L2_Theme.measureText(c, item.label, L2_Theme.fontNormal);
            c.drawText(item.label, x, 0, tw + 4, ch, 'left');

            // Store hit area
            item._x = x;
            item._w = tw + 4;

            x += tw + 4;
            if (!isLast) {
                c.textColor = L2_Theme.textDim;
                c.drawText(' / ', x, 0, 20, ch, 'left');
                x += 18;
            }
        });
    };

    L2_Breadcrumb.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var ch = this.ch();
        var inside = loc.y >= 0 && loc.y < ch;
        var oldHover = this._hoverIndex;
        this._hoverIndex = -1;

        if (inside) {
            for (var i = 0; i < this._items.length - 1; i++) {
                var item = this._items[i];
                if (loc.x >= item._x && loc.x < item._x + item._w) {
                    this._hoverIndex = i;
                    break;
                }
            }
        }
        if (this._hoverIndex !== oldHover) this.markDirty();
        if (TouchInput.isTriggered() && this._hoverIndex >= 0) {
            var clicked = this._items[this._hoverIndex];
            if (clicked && clicked.action) clicked.action();
        }
    };

    window.L2_Breadcrumb = L2_Breadcrumb;
})();

// ═══ ui/window/subwindow.js ═══
/**
 * L2_SubWindow - Draggable, closable sub-window panel with title bar.
 */
(function () {
    'use strict';

    function L2_SubWindow() { this.initialize.apply(this, arguments); }
    L2_SubWindow.prototype = Object.create(L2_Base.prototype);
    L2_SubWindow.prototype.constructor = L2_SubWindow;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {number} h
     * @param {object} [opts] - { title, closable, draggable, onClose }
     */
    L2_SubWindow.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._title = opts.title || '';
        this._closable = opts.closable !== false;
        this._draggable = opts.draggable !== false;
        this._onClose = opts.onClose || null;
        this._dragging = false;
        this._dragStartX = 0;
        this._dragStartY = 0;
        this._dragOffX = 0;
        this._dragOffY = 0;
        this._closeHover = false;
        this._dragThreshold = L2_Theme.dragThreshold;
        this.refresh();
    };

    L2_SubWindow.prototype.setTitle = function (t) {
        this._title = t;
        this.markDirty();
    };

    L2_SubWindow.prototype.onClose = function (fn) { this._onClose = fn; };

    /** Content Y start (below title bar). */
    L2_SubWindow.prototype.contentY = function () {
        return this._title ? L2_Theme.titleBarH + 4 : 4;
    };

    /** Content height (minus title bar and padding). */
    L2_SubWindow.prototype.contentH = function () {
        return this.ch() - this.contentY() - 4;
    };

    L2_SubWindow.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        // Panel background
        L2_Theme.drawPanelBg(c, 0, 0, cw, ch);

        // Title bar
        if (this._title) {
            L2_Theme.drawTitleBar(c, 0, 0, cw, L2_Theme.titleBarH, this._title);
        }

        // Close button
        if (this._closable) {
            var btnSize = 18;
            L2_Theme.drawCloseBtn(c, cw - btnSize - 4, 4, btnSize, this._closeHover);
        }

        // Let subclasses draw content
        this.drawContent(c, cw, ch);
    };

    /** Override in subclasses for custom content. */
    L2_SubWindow.prototype.drawContent = function (/* bmp, cw, ch */) {};

    L2_SubWindow.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        this._handleDrag();
        this._handleClose();
    };

    L2_SubWindow.prototype._handleDrag = function () {
        if (!this._draggable) return;
        if (TouchInput.isPressed()) {
            var tx = TouchInput.x, ty = TouchInput.y;
            if (!this._dragging && TouchInput.isTriggered()) {
                var barH = this._title ? L2_Theme.titleBarH : 0;
                if (barH > 0 && this.isInside(tx, ty) &&
                    ty <= this.y + this.padding + barH) {
                    // 记录拖拽起始位置，但暂不开始拖拽
                    this._dragStartX = tx;
                    this._dragStartY = ty;
                    this._dragOffX = tx - this.x;
                    this._dragOffY = ty - this.y;
                    this._dragging = false;
                    this._dragPending = true;
                }
            }
            if (this._dragPending) {
                // 检查是否超过拖拽阈值
                var dx = Math.abs(tx - this._dragStartX);
                var dy = Math.abs(ty - this._dragStartY);
                if (dx > this._dragThreshold || dy > this._dragThreshold) {
                    this._dragging = true;
                    this._dragPending = false;
                }
            }
            if (this._dragging) {
                this.x = Math.max(0, Math.min(tx - this._dragOffX, Graphics.boxWidth - this.width));
                this.y = Math.max(0, Math.min(ty - this._dragOffY, Graphics.boxHeight - this.height));
            }
        } else {
            this._dragging = false;
            this._dragPending = false;
        }
    };

    L2_SubWindow.prototype._handleClose = function () {
        if (!this._closable) return;
        var cw = this.cw();
        var btnSize = 18;
        var btnX = this.x + this.padding + cw - btnSize - 4;
        var btnY = this.y + this.padding + 4;
        var mx = TouchInput.x, my = TouchInput.y;
        var wasHover = this._closeHover;
        this._closeHover = mx >= btnX && mx <= btnX + btnSize &&
                           my >= btnY && my <= btnY + btnSize;
        if (this._closeHover !== wasHover) this.markDirty();
        if (this._closeHover && TouchInput.isTriggered()) {
            this.visible = false;
            if (this._onClose) this._onClose();
        }
    };

    window.L2_SubWindow = L2_SubWindow;
})();

// ═══ ui/window/fullscreen.js ═══
/**
 * L2_FullscreenWindow - Full-screen overlay window with dark background.
 */
(function () {
    'use strict';

    function L2_FullscreenWindow() { this.initialize.apply(this, arguments); }
    L2_FullscreenWindow.prototype = Object.create(L2_Base.prototype);
    L2_FullscreenWindow.prototype.constructor = L2_FullscreenWindow;

    /**
     * @param {object} [opts] - { title, closable, onClose, bgOpacity }
     */
    L2_FullscreenWindow.prototype.initialize = function (opts) {
        opts = opts || {};
        L2_Base.prototype.initialize.call(this, 0, 0, Graphics.boxWidth, Graphics.boxHeight);
        this._title = opts.title || '';
        this._closable = opts.closable !== false;
        this._onClose = opts.onClose || null;
        this._bgOpacity = opts.bgOpacity !== undefined ? opts.bgOpacity : 0.7;
        this._closeHover = false;
        this.refresh();
    };

    L2_FullscreenWindow.prototype.standardPadding = function () { return 0; };

    L2_FullscreenWindow.prototype.contentY = function () {
        return this._title ? L2_Theme.titleBarH + 8 : 8;
    };

    L2_FullscreenWindow.prototype.contentH = function () {
        return this.ch() - this.contentY() - 8;
    };

    L2_FullscreenWindow.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        // Dark overlay background
        c.fillRect(0, 0, cw, ch, 'rgba(0,0,0,' + this._bgOpacity + ')');

        // Title bar
        if (this._title) {
            c.gradientFillRect(0, 0, cw, L2_Theme.titleBarH, L2_Theme.bgHeader, L2_Theme.bgHeaderEnd, false);
            c.fillRect(0, L2_Theme.titleBarH - 1, cw, 1, L2_Theme.borderDark);
            c.fontSize = L2_Theme.fontH2;
            c.textColor = L2_Theme.textTitle;
            c.drawText(this._title, 16, 3, cw - 48, L2_Theme.titleBarH - 4, 'left');
        }

        // Close button
        if (this._closable) {
            var btnSize = 20;
            L2_Theme.drawCloseBtn(c, cw - btnSize - 8, 3, btnSize, this._closeHover);
        }

        this.drawContent(c, cw, ch);
    };

    L2_FullscreenWindow.prototype.drawContent = function (/* bmp, cw, ch */) {};

    L2_FullscreenWindow.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        if (this._closable) {
            var cw = this.cw();
            var btnSize = 20;
            var btnX = cw - btnSize - 8;
            var btnY = 3;
            var mx = TouchInput.x, my = TouchInput.y;
            var wasHover = this._closeHover;
            this._closeHover = mx >= btnX && mx <= btnX + btnSize &&
                               my >= btnY && my <= btnY + btnSize;
            if (this._closeHover !== wasHover) this.markDirty();
            if (this._closeHover && TouchInput.isTriggered()) {
                this.visible = false;
                if (this._onClose) this._onClose();
            }
        }
        // ESC to close
        if (Input.isTriggered('escape') || Input.isTriggered('cancel')) {
            this.visible = false;
            if (this._onClose) this._onClose();
        }
    };

    L2_FullscreenWindow.prototype.onClose = function (fn) { this._onClose = fn; };

    window.L2_FullscreenWindow = L2_FullscreenWindow;
})();

// ═══ ui/input/input.js ═══
/**
 * L2_Input - Canvas-rendered text input field.
 */
(function () {
    'use strict';

    function L2_Input() { this.initialize.apply(this, arguments); }
    L2_Input.prototype = Object.create(L2_Base.prototype);
    L2_Input.prototype.constructor = L2_Input;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { placeholder, maxLength, onChange, onSubmit, password }
     */
    L2_Input.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        L2_Base.prototype.initialize.call(this, x, y, w, (opts.height || 28) + 4);
        this._text = '';
        this._placeholder = opts.placeholder || '';
        this._maxLength = opts.maxLength || 100;
        this._password = opts.password || false;
        this._focused = false;
        this._cursorBlink = 0;
        this._onChange = opts.onChange || null;
        this._onSubmit = opts.onSubmit || null;
        this.refresh();
    };

    L2_Input.prototype.standardPadding = function () { return 2; };

    L2_Input.prototype.getText = function () { return this._text; };
    L2_Input.prototype.setText = function (t) { this._text = String(t); this.markDirty(); };
    L2_Input.prototype.setFocused = function (b) { this._focused = b; this._cursorBlink = 0; this.markDirty(); };
    L2_Input.prototype.isFocused = function () { return this._focused; };

    L2_Input.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        c.fillRect(0, 0, cw, ch, this._focused ? '#0E0E22' : L2_Theme.bgInput);
        L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, 2,
            this._focused ? L2_Theme.borderActive : L2_Theme.borderDark);

        c.fontSize = L2_Theme.fontNormal;
        if (this._text) {
            c.textColor = L2_Theme.textWhite;
            var display = this._password ? '\u2022'.repeat(this._text.length) : this._text;
            if (this._focused && this._cursorBlink < 30) display += '|';
            c.drawText(display, 6, 0, cw - 12, ch, 'left');
        } else {
            c.textColor = L2_Theme.textDim;
            var ph = this._placeholder;
            if (this._focused && this._cursorBlink < 30) ph = '|';
            c.drawText(ph, 6, 0, cw - 12, ch, 'left');
        }
    };

    L2_Input.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        if (TouchInput.isTriggered()) {
            this.setFocused(this.isInside(TouchInput.x, TouchInput.y));
        }

        if (!this._focused) return;

        this._cursorBlink = (this._cursorBlink + 1) % 60;
        if (this._cursorBlink === 0 || this._cursorBlink === 30) this.markDirty();

        var changed = false;
        // 使用查找对象代替循环，性能更好
        var keyMap = Input._keys || {};
        // 支持的字符集
        var validChars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:\'",.<>?/~`\\ ';
        for (var key in keyMap) {
            if (keyMap[key] && validChars.indexOf(key) >= 0 && this._text.length < this._maxLength) {
                this._text += key;
                keyMap[key] = false;
                changed = true;
            }
        }
        // Space (映射为空格字符)
        if (Input.isTriggered('space') && this._text.length < this._maxLength) {
            this._text += ' ';
            changed = true;
        }
        if (Input.isTriggered('backspace') && this._text.length > 0) {
            this._text = this._text.slice(0, -1);
            changed = true;
        }
        if (Input.isTriggered('ok')) {
            this._focused = false;
            if (this._onSubmit) this._onSubmit(this._text);
            this.refresh();
        }
        if (Input.isTriggered('escape')) {
            this._focused = false;
            this.refresh();
        }
        if (changed) {
            if (this._onChange) this._onChange(this._text);
            this.markDirty();
        }
    };

    window.L2_Input = L2_Input;
})();

// ═══ ui/input/input-number.js ═══
/**
 * L2_InputNumber - Numeric input with +/- buttons.
 */
(function () {
    'use strict';

    function L2_InputNumber() { this.initialize.apply(this, arguments); }
    L2_InputNumber.prototype = Object.create(L2_Base.prototype);
    L2_InputNumber.prototype.constructor = L2_InputNumber;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { min, max, step, value, width, onChange }
     */
    L2_InputNumber.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        var w = opts.width || 130;
        L2_Base.prototype.initialize.call(this, x, y, w, 28 + 4);
        this._min = opts.min !== undefined ? opts.min : 0;
        this._max = opts.max !== undefined ? opts.max : 99999;
        this._step = opts.step || 1;
        this._value = opts.value || this._min;
        this._onChange = opts.onChange || null;
        this._focused = false;
        this._text = String(this._value);
        this._hoverBtn = 0; // -1=minus, 1=plus
        this._cursorBlink = 0;
        this.refresh();
    };

    L2_InputNumber.prototype.standardPadding = function () { return 2; };

    L2_InputNumber.prototype.getValue = function () { return this._value; };
    L2_InputNumber.prototype.setValue = function (v) {
        var newVal = Math.max(this._min, Math.min(v, this._max));
        if (newVal === this._value) return;
        this._value = newVal;
        this._text = String(this._value);
        if (this._onChange) this._onChange(this._value);
        this.markDirty();
    };

    L2_InputNumber.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var btnW = 24;

        // Minus button
        var minusBg = this._hoverBtn === -1 ? L2_Theme.bgButtonHover : L2_Theme.bgButton;
        L2_Theme.fillRoundRect(c, 0, 0, btnW, ch, 2, minusBg);
        L2_Theme.strokeRoundRect(c, 0, 0, btnW, ch, 2, L2_Theme.borderDark);
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        c.drawText('-', 0, 0, btnW, ch, 'center');

        // Number field
        var fieldX = btnW + 2;
        var fieldW = cw - btnW * 2 - 4;
        c.fillRect(fieldX, 0, fieldW, ch, this._focused ? '#0E0E22' : L2_Theme.bgInput);
        L2_Theme.strokeRoundRect(c, fieldX, 0, fieldW, ch, 2,
            this._focused ? L2_Theme.borderActive : L2_Theme.borderDark);
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        var display = this._focused ? this._text : String(this._value);
        if (this._focused && this._cursorBlink < 30) display += '|';
        c.drawText(display, fieldX + 4, 0, fieldW - 8, ch, 'center');

        // Plus button
        var plusX = cw - btnW;
        var plusBg = this._hoverBtn === 1 ? L2_Theme.bgButtonHover : L2_Theme.bgButton;
        L2_Theme.fillRoundRect(c, plusX, 0, btnW, ch, 2, plusBg);
        L2_Theme.strokeRoundRect(c, plusX, 0, btnW, ch, 2, L2_Theme.borderDark);
        c.textColor = L2_Theme.textWhite;
        c.drawText('+', plusX, 0, btnW, ch, 'center');
    };

    L2_InputNumber.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw(), ch = this.ch();
        var btnW = 24;

        // Hover
        var oldHover = this._hoverBtn;
        this._hoverBtn = 0;
        if (loc.y >= 0 && loc.y < ch) {
            if (loc.x >= 0 && loc.x < btnW) this._hoverBtn = -1;
            else if (loc.x >= cw - btnW) this._hoverBtn = 1;
        }
        if (this._hoverBtn !== oldHover) this.markDirty();

        if (TouchInput.isTriggered()) {
            if (this._hoverBtn === -1) {
                this.setValue(this._value - this._step);
                return;
            }
            if (this._hoverBtn === 1) {
                this.setValue(this._value + this._step);
                return;
            }
            var insideField = loc.x >= btnW && loc.x < cw - btnW && loc.y >= 0 && loc.y < ch;
            this._focused = insideField;
            if (this._focused) this._text = String(this._value);
            this._cursorBlink = 0;
            this.markDirty();
        }

        if (!this._focused) return;

        this._cursorBlink = (this._cursorBlink + 1) % 60;
        if (this._cursorBlink === 0 || this._cursorBlink === 30) this.markDirty();

        var changed = false;
        for (var k = 0; k <= 9; k++) {
            if (Input.isTriggered(String(k))) {
                if (this._text === '0') this._text = '';
                this._text += String(k);
                changed = true;
            }
        }
        if (Input.isTriggered('backspace')) {
            this._text = this._text.slice(0, -1) || '0';
            changed = true;
        }
        if (Input.isTriggered('ok') || Input.isTriggered('escape')) {
            this._focused = false;
            this._value = Math.max(this._min, Math.min(parseInt(this._text, 10) || 0, this._max));
            this._text = String(this._value);
            if (this._onChange) this._onChange(this._value);
            this.markDirty();
        }
        if (changed) this.markDirty();
    };

    window.L2_InputNumber = L2_InputNumber;
})();

// ═══ ui/input/select.js ═══
/**
 * L2_Select - Dropdown selection component.
 */
(function () {
    'use strict';

    function L2_Select() { this.initialize.apply(this, arguments); }
    L2_Select.prototype = Object.create(L2_Base.prototype);
    L2_Select.prototype.constructor = L2_Select;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { options: [{label,value}], selected, placeholder, onChange }
     */
    L2_Select.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        L2_Base.prototype.initialize.call(this, x, y, w, 28 + 4);
        this._options = opts.options || [];
        this._selectedIndex = opts.value !== undefined ? opts.value : (opts.selectedIndex !== undefined ? opts.selectedIndex : -1);
        this._placeholder = opts.placeholder || '\u8BF7\u9009\u62E9...';
        this._onChange = opts.onChange || null;
        this._open = false;
        this._hoverOption = -1;
        this._itemHeight = 26;
        this.refresh();
    };

    L2_Select.prototype.standardPadding = function () { return 2; };

    L2_Select.prototype.getSelected = function () {
        if (!this._options || this._selectedIndex < 0 || this._selectedIndex >= this._options.length) {
            return null;
        }
        return this._options[this._selectedIndex];
    };

    L2_Select.prototype.getValue = function () {
        var sel = this.getSelected();
        return sel ? sel.value : null;
    };

    L2_Select.prototype.setSelectedIndex = function (idx) {
        if (idx === this._selectedIndex) return;
        this._selectedIndex = idx;
        if (this._onChange) this._onChange(this.getSelected(), idx);
        this.markDirty();
    };

    /** @deprecated Use setSelectedIndex instead */
    L2_Select.prototype.setValue = function (idx) {
        this.setSelectedIndex(idx);
    };

    L2_Select.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var sel = this.getSelected();

        // Trigger
        L2_Theme.fillRoundRect(c, 0, 0, cw, 28, L2_Theme.cornerRadius, L2_Theme.bgInput);
        L2_Theme.strokeRoundRect(c, 0, 0, cw, 28, L2_Theme.cornerRadius, L2_Theme.borderDark);
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = sel ? L2_Theme.textWhite : L2_Theme.textDim;
        c.drawText(sel ? sel.label : this._placeholder, 8, 4, cw - 28, 20, 'left');
        c.textColor = L2_Theme.textGray;
        c.drawText(this._open ? '\u25B2' : '\u25BC', cw - 22, 4, 18, 20, 'center');

        // Dropdown
        if (this._open) {
            var listH = this._options.length * this._itemHeight + 4;
            var listY = 30;
            L2_Theme.fillRoundRect(c, 0, listY, cw, listH, L2_Theme.cornerRadius, L2_Theme.bgPanel);
            L2_Theme.strokeRoundRect(c, 0, listY, cw, listH, L2_Theme.cornerRadius, L2_Theme.borderDark);

            var ih = this._itemHeight;
            var self = this;
            (this._options || []).forEach(function (opt, i) {
                var iy = listY + 2 + i * ih;
                if (i === self._selectedIndex) {
                    c.fillRect(2, iy, cw - 4, ih, L2_Theme.selection);
                } else if (i === self._hoverOption) {
                    c.fillRect(2, iy, cw - 4, ih, L2_Theme.highlight);
                }
                c.fontSize = L2_Theme.fontNormal;
                c.textColor = i === self._selectedIndex ? L2_Theme.textGold : L2_Theme.textWhite;
                c.drawText(opt.label, 10, iy + 3, cw - 20, ih - 6, 'left');
            });
        }
    };

    L2_Select.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw();
        var ih = this._itemHeight;

        if (this._open) {
            var listY = 30;
            var oldHover = this._hoverOption;
            if (loc.x >= 0 && loc.x < cw && loc.y >= listY) {
                this._hoverOption = Math.floor((loc.y - listY - 2) / ih);
                if (this._hoverOption >= this._options.length) this._hoverOption = -1;
            } else {
                this._hoverOption = -1;
            }
            if (this._hoverOption !== oldHover) this.markDirty();
        }

        if (TouchInput.isTriggered()) {
            var insideTrigger = loc.x >= 0 && loc.x < cw && loc.y >= 0 && loc.y < 28;
            if (insideTrigger) {
                this._open = !this._open;
                var totalH = this._open ? 32 + (this._options ? this._options.length : 0) * ih + 8 : 32;
                this.move(this.x, this.y, this.width, totalH);
                this.createContents();
                this.markDirty();
                return;
            }
            if (this._open && this._hoverOption >= 0 && this._options && this._hoverOption < this._options.length) {
                this.setSelectedIndex(this._hoverOption);
                this._open = false;
                this.move(this.x, this.y, this.width, 32);
                this.createContents();
                this.refresh();
                return;
            }
            if (this._open) {
                this._open = false;
                this.move(this.x, this.y, this.width, 32);
                this.createContents();
                this.refresh();
            }
        }
    };

    window.L2_Select = L2_Select;
})();

// ═══ ui/input/checkbox.js ═══
/**
 * L2_Checkbox - Toggle checkbox with label.
 */
(function () {
    'use strict';

    function L2_Checkbox() { this.initialize.apply(this, arguments); }
    L2_Checkbox.prototype = Object.create(L2_Base.prototype);
    L2_Checkbox.prototype.constructor = L2_Checkbox;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { label, checked, onChange }
     */
    L2_Checkbox.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._label = opts.label || '';
        var w = opts.width || Math.max(this._label.length * 10 + 28, 60);
        L2_Base.prototype.initialize.call(this, x, y, w, 24 + 4);
        this._checked = opts.checked || false;
        this._onChange = opts.onChange || null;
        this._hover = false;
        this.refresh();
    };

    L2_Checkbox.prototype.standardPadding = function () { return 2; };

    L2_Checkbox.prototype.isChecked = function () { return this._checked; };
    L2_Checkbox.prototype.setChecked = function (b) {
        this._checked = b;
        if (this._onChange) this._onChange(b);
        this.markDirty();
    };

    L2_Checkbox.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var ch = this.ch();
        var boxSize = 16;
        var boxY = (ch - boxSize) / 2;

        // Box
        var bg = this._checked ? '#1A2A55' : L2_Theme.bgInput;
        var border = this._checked ? L2_Theme.borderActive :
                     (this._hover ? L2_Theme.borderGold : L2_Theme.borderDark);
        L2_Theme.fillRoundRect(c, 0, boxY, boxSize, boxSize, 2, bg);
        L2_Theme.strokeRoundRect(c, 0, boxY, boxSize, boxSize, 2, border);

        if (this._checked) {
            L2_Theme.drawCheck(c, 0, boxY, boxSize, L2_Theme.textGold);
        }

        // Label
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._label, boxSize + 8, 0, this.cw() - boxSize - 8, ch, 'left');
    };

    L2_Checkbox.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var wasHover = this._hover;
        this._hover = this.isInside(TouchInput.x, TouchInput.y);
        if (this._hover !== wasHover) this.markDirty();
        if (this._hover && TouchInput.isTriggered()) {
            this.setChecked(!this._checked);
        }
    };

    window.L2_Checkbox = L2_Checkbox;
})();

// ═══ ui/input/radio.js ═══
/**
 * L2_Radio - Radio button group.
 */
(function () {
    'use strict';

    function L2_Radio() { this.initialize.apply(this, arguments); }
    L2_Radio.prototype = Object.create(L2_Base.prototype);
    L2_Radio.prototype.constructor = L2_Radio;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { items, selected, direction:'vertical'|'horizontal', onChange }
     */
    L2_Radio.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._radioOptions = opts.items || [];
        this._direction = opts.direction || 'vertical';
        var w = opts.width || 200;
        var itemH = 24;
        var h = this._direction === 'vertical'
            ? this._radioOptions.length * itemH + 8
            : itemH + 8;
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this._selectedIndex = opts.value !== undefined ? opts.value : (opts.selectedIndex !== undefined ? opts.selectedIndex : 0);
        this._onChange = opts.onChange || null;
        this._hoverIndex = -1;
        this.refresh();
    };

    L2_Radio.prototype.standardPadding = function () { return 4; };

    L2_Radio.prototype.getSelectedIndex = function () { return this._selectedIndex; };
    L2_Radio.prototype.getSelectedLabel = function () { return this._radioOptions[this._selectedIndex]; };

    L2_Radio.prototype.setSelectedIndex = function (idx) {
        if (idx === this._selectedIndex) return;
        this._selectedIndex = idx;
        if (this._onChange) this._onChange(idx, this._radioOptions[idx]);
        this.markDirty();
    };

    /** @deprecated Use setSelectedIndex instead */
    L2_Radio.prototype.setValue = function (idx) {
        this.setSelectedIndex(idx);
    };

    L2_Radio.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var itemH = 24;
        var isH = this._direction === 'horizontal';
        var itemW = isH ? Math.floor(cw / Math.max(this._radioOptions.length, 1)) : cw;
        var self = this;

        this._radioOptions.forEach(function (label, i) {
            var ix = isH ? i * itemW : 0;
            var iy = isH ? 0 : i * itemH;
            var selected = i === self._selectedIndex;
            var hover = i === self._hoverIndex;
            var dotR = 7;
            var dotCX = ix + dotR + 2;
            var dotCY = iy + itemH / 2;

            // Outer circle
            L2_Theme.drawCircle(c, dotCX, dotCY, dotR,
                selected ? L2_Theme.borderActive :
                (hover ? L2_Theme.borderGold : L2_Theme.borderDark));
            // Inner bg
            L2_Theme.drawCircle(c, dotCX, dotCY, dotR - 2, L2_Theme.bgInput);
            // Selected dot
            if (selected) {
                L2_Theme.drawCircle(c, dotCX, dotCY, 3, L2_Theme.textGold);
            }

            c.fontSize = L2_Theme.fontNormal;
            c.textColor = L2_Theme.textWhite;
            c.drawText(label, ix + dotR * 2 + 8, iy, itemW - dotR * 2 - 10, itemH, 'left');
        });
    };

    L2_Radio.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var itemH = 24;
        var isH = this._direction === 'horizontal';
        var itemW = isH ? Math.floor(this.cw() / Math.max(this._radioOptions.length, 1)) : this.cw();
        var oldHover = this._hoverIndex;
        this._hoverIndex = -1;

        if (loc.x >= 0 && loc.x < this.cw() && loc.y >= 0 && loc.y < this.ch()) {
            if (isH) {
                this._hoverIndex = Math.min(Math.floor(loc.x / itemW), this._radioOptions.length - 1);
            } else {
                this._hoverIndex = Math.min(Math.floor(loc.y / itemH), this._radioOptions.length - 1);
            }
        }
        if (this._hoverIndex !== oldHover) this.markDirty();
        if (TouchInput.isTriggered() && this._hoverIndex >= 0) {
            this.setSelectedIndex(this._hoverIndex);
        }
    };

    window.L2_Radio = L2_Radio;
})();

// ═══ ui/input/switch.js ═══
/**
 * L2_Switch - Toggle switch (on/off).
 */
(function () {
    'use strict';

    function L2_Switch() { this.initialize.apply(this, arguments); }
    L2_Switch.prototype = Object.create(L2_Base.prototype);
    L2_Switch.prototype.constructor = L2_Switch;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { on, label, onChange }
     */
    L2_Switch.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._label = opts.label || '';
        L2_Base.prototype.initialize.call(this, x, y, (opts.width || 90) + 4, 24 + 4);
        this._on = opts.on || opts.value || false;
        this._onChange = opts.onChange || null;
        this._hover = false;
        this._animPos = this._on ? 1 : 0;
        this.refresh();
    };

    L2_Switch.prototype.standardPadding = function () { return 2; };

    L2_Switch.prototype.isOn = function () { return this._on; };
    L2_Switch.prototype.setOn = function (b) {
        if (this._on === b) return;
        this._on = b;
        if (this._onChange) this._onChange(b);
        this.markDirty();
    };

    L2_Switch.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var ch = this.ch();
        var trackW = 36, trackH = 18;
        var trackY = (ch - trackH) / 2;
        var knobR = 7;

        // Track
        var trackColor = this._on ? '#1A4A2A' : '#2A2A3A';
        var borderColor = this._on ? L2_Theme.textGreen : L2_Theme.borderDark;
        L2_Theme.fillRoundRect(c, 0, trackY, trackW, trackH, trackH / 2, trackColor);
        L2_Theme.strokeRoundRect(c, 0, trackY, trackW, trackH, trackH / 2, borderColor);

        // Knob
        var knobX = this._on ? trackW - knobR - 3 : knobR + 3;
        var knobColor = this._on ? L2_Theme.textGreen : L2_Theme.textGray;
        L2_Theme.drawCircle(c, knobX, trackY + trackH / 2, knobR, knobColor);

        // Label
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._label, trackW + 8, 0, this.cw() - trackW - 8, ch, 'left');
    };

    L2_Switch.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var wasHover = this._hover;
        this._hover = this.isInside(TouchInput.x, TouchInput.y);
        if (this._hover !== wasHover) this.markDirty();
        if (this._hover && TouchInput.isTriggered()) {
            this.setOn(!this._on);
        }
    };

    window.L2_Switch = L2_Switch;
})();

// ═══ ui/input/slider.js ═══
/**
 * L2_Slider - Draggable range slider.
 */
(function () {
    'use strict';

    function L2_Slider() { this.initialize.apply(this, arguments); }
    L2_Slider.prototype = Object.create(L2_Base.prototype);
    L2_Slider.prototype.constructor = L2_Slider;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { min, max, value, step, showValue, onChange }
     */
    L2_Slider.prototype.initialize = function (x, y, w, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, 28 + 4);
        opts = opts || {};
        this._min = opts.min !== undefined ? opts.min : 0;
        this._max = opts.max !== undefined ? opts.max : 100;
        this._value = opts.value !== undefined ? opts.value : this._min;
        this._step = opts.step || 1;
        this._showValue = opts.showValue !== false;
        this._onChange = opts.onChange || null;
        this._dragging = false;
        this.refresh();
    };

    L2_Slider.prototype.standardPadding = function () { return 2; };

    L2_Slider.prototype.getValue = function () { return this._value; };
    L2_Slider.prototype.setValue = function (v) {
        v = Math.max(this._min, Math.min(v, this._max));
        v = Math.round(v / this._step) * this._step;
        if (v !== this._value) {
            this._value = v;
            if (this._onChange) this._onChange(v);
            this.markDirty();
        }
    };

    L2_Slider.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var valueW = this._showValue ? 40 : 0;
        var trackW = cw - valueW;
        var trackH = 6;
        var trackY = ch / 2 - trackH / 2;
        var ratio = (this._value - this._min) / Math.max(this._max - this._min, 1);
        var knobX = Math.round(ratio * (trackW - 8)) + 4;
        var knobR = 8;

        // Track bg
        L2_Theme.fillRoundRect(c, 0, trackY, trackW, trackH, 3, L2_Theme.borderDark);
        // Track fill
        L2_Theme.fillRoundRect(c, 0, trackY, knobX, trackH, 3, L2_Theme.textBlue);
        // Knob
        L2_Theme.drawCircle(c, knobX, ch / 2, knobR, '#FFFFFF');
        L2_Theme.drawCircle(c, knobX, ch / 2, knobR - 2, L2_Theme.textBlue);

        // Value label
        if (this._showValue) {
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textWhite;
            c.drawText(String(this._value), trackW + 4, 0, valueW - 4, ch, 'left');
        }
    };

    L2_Slider.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw();
        var valueW = this._showValue ? 40 : 0;
        var trackW = cw - valueW;

        if (TouchInput.isTriggered() && this.isInside(TouchInput.x, TouchInput.y)) {
            this._dragging = true;
        }
        if (!TouchInput.isPressed()) this._dragging = false;

        if (this._dragging) {
            var ratio = Math.max(0, Math.min((loc.x - 4) / (trackW - 8), 1));
            var val = this._min + ratio * (this._max - this._min);
            this.setValue(val);
        }
    };

    window.L2_Slider = L2_Slider;
})();

// ═══ ui/input/textarea.js ═══
/**
 * L2_Textarea - Multi-line text display/input area.
 */
(function () {
    'use strict';

    function L2_Textarea() { this.initialize.apply(this, arguments); }
    L2_Textarea.prototype = Object.create(L2_Base.prototype);
    L2_Textarea.prototype.constructor = L2_Textarea;

    L2_Textarea.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._text = opts.text || '';
        this._lineHeight = opts.lineHeight || 18;
        this._scrollY = 0;
        this._editable = opts.editable || false;
        this._focused = false;
        this._cursorBlink = 0;
        this._onChange = opts.onChange || null;
        this.refresh();
    };

    L2_Textarea.prototype.standardPadding = function () { return 4; };

    L2_Textarea.prototype.getText = function () { return this._text; };
    L2_Textarea.prototype.setText = function (t) { this._text = t; this._scrollY = 0; this.markDirty(); };

    L2_Textarea.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        c.fillRect(0, 0, cw, ch, L2_Theme.bgDark);
        L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, 2,
            this._focused ? L2_Theme.borderActive : L2_Theme.borderDark);

        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;

        var lines = this._text.split('\n');
        var lh = this._lineHeight;
        var startLine = Math.floor(this._scrollY / lh);
        var visLines = Math.ceil(ch / lh);

        for (var i = startLine; i < Math.min(startLine + visLines, lines.length); i++) {
            var ly = i * lh - this._scrollY + 2;
            if (ly + lh < 0 || ly > ch) continue;
            c.drawText(lines[i], 4, ly, cw - 8, lh, 'left');
        }

        // Scrollbar
        var totalH = lines.length * lh;
        if (totalH > ch) {
            var sbW = 4;
            var thumbH = Math.max(16, Math.round(ch * (ch / totalH)));
            var thumbY = Math.round((ch - thumbH) * (this._scrollY / (totalH - ch)));
            c.fillRect(cw - sbW, 0, sbW, ch, 'rgba(0,0,0,0.3)');
            L2_Theme.fillRoundRect(c, cw - sbW, thumbY, sbW, thumbH, 2, '#444466');
        }
    };

    L2_Textarea.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var inside = this.isInside(TouchInput.x, TouchInput.y);

        if (TouchInput.isTriggered()) {
            this._focused = inside && this._editable;
            this._cursorBlink = 0;
            this.markDirty();
        }

        // Scroll
        if (inside && TouchInput.wheelY) {
            var lh = this._lineHeight;
            var lines = this._text.split('\n');
            var totalH = lines.length * lh;
            this._scrollY += TouchInput.wheelY > 0 ? lh * 2 : -lh * 2;
            this._scrollY = Math.max(0, Math.min(this._scrollY, Math.max(0, totalH - this.ch())));
            this.markDirty();
        }

        // Keyboard input (when editable and focused)
        if (this._focused && this._editable) {
            this._cursorBlink = (this._cursorBlink + 1) % 60;
            var changed = false;
            // 使用查找对象代替循环，性能更好
            var keyMap = Input._keys || {};
            var validChars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:\'",.<>?/~`\\ ';
            for (var key in keyMap) {
                if (keyMap[key] && validChars.indexOf(key) >= 0) {
                    this._text += key;
                    keyMap[key] = false;
                    changed = true;
                }
            }
            if (Input.isTriggered('space')) { this._text += ' '; changed = true; }
            if (Input.isTriggered('backspace') && this._text.length > 0) {
                this._text = this._text.slice(0, -1);
                changed = true;
            }
            if (Input.isTriggered('escape')) { this._focused = false; this.markDirty(); }
            if (changed) {
                if (this._onChange) this._onChange(this._text);
                this.markDirty();
            }
        }
    };

    window.L2_Textarea = L2_Textarea;
})();

// ═══ ui/data/list.js ═══
/**
 * L2_List - Scrollable list with selection and hover.
 */
(function () {
    'use strict';

    function L2_List() { this.initialize.apply(this, arguments); }
    L2_List.prototype = Object.create(L2_Base.prototype);
    L2_List.prototype.constructor = L2_List;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {number} h
     * @param {object} [opts] - { itemHeight, onSelect, drawItem }
     */
    L2_List.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._items = [];
        this._itemHeight = opts.itemHeight || L2_Theme.defaultItemHeight;
        this._scrollY = 0;
        this._selectedIndex = -1;
        this._hoverIndex = -1;
        this._onSelect = opts.onSelect || null;
        this._drawItemFn = opts.drawItem || null;
        this.refresh();
    };

    L2_List.prototype.standardPadding = function () { return 4; };

    L2_List.prototype.setItems = function (items) {
        this._items = items || [];
        this._scrollY = 0;
        this._selectedIndex = -1;
        this.markDirty();
    };

    L2_List.prototype.getSelected = function () {
        return this._selectedIndex >= 0 ? this._items[this._selectedIndex] : null;
    };

    L2_List.prototype.getSelectedIndex = function () { return this._selectedIndex; };

    L2_List.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        c.fillRect(0, 0, cw, ch, L2_Theme.bgDark);
        L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, 2, L2_Theme.borderDark);

        var ih = this._itemHeight;
        var sbW = L2_Theme.scrollbarWidth;
        var startIdx = Math.floor(this._scrollY / ih);
        var visCount = Math.ceil(ch / ih) + 1;

        for (var i = startIdx; i < Math.min(startIdx + visCount, this._items.length); i++) {
            var iy = i * ih - this._scrollY;
            if (iy + ih < 0 || iy > ch) continue;

            if (i === this._selectedIndex) {
                c.fillRect(1, iy, cw - sbW - 2, ih, L2_Theme.selection);
            } else if (i === this._hoverIndex) {
                c.fillRect(1, iy, cw - sbW - 2, ih, L2_Theme.highlight);
            }

            c.fillRect(2, iy + ih - 1, cw - sbW - 4, 1, L2_Theme.borderDark);

            if (this._drawItemFn) {
                this._drawItemFn(c, this._items[i], 4, iy, cw - sbW - 8, ih, i);
            } else {
                var item = this._items[i];
                c.fontSize = L2_Theme.fontNormal;
                c.textColor = item.color || L2_Theme.textWhite;
                c.drawText(item.text || String(item), 4, iy + 2, cw - sbW - 8, ih - 4, 'left');
                if (item.subText) {
                    c.fontSize = L2_Theme.fontSmall;
                    c.textColor = L2_Theme.textGray;
                    c.drawText(item.subText, 4, iy + 2, cw - sbW - 8, ih - 4, 'right');
                }
            }
        }

        // Scrollbar
        var totalH = this._items.length * ih;
        if (totalH > ch) {
            var trackH = ch - 4;
            var thumbH = Math.max(20, Math.round(trackH * (ch / totalH)));
            var thumbY = 2 + Math.round((trackH - thumbH) * (this._scrollY / (totalH - ch)));
            c.fillRect(cw - sbW, 0, sbW, ch, 'rgba(0,0,0,0.3)');
            L2_Theme.fillRoundRect(c, cw - sbW, thumbY, sbW, thumbH, 2, '#444466');
        }
    };

    L2_List.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw(), ch = this.ch();
        var ih = this._itemHeight;
        var inside = loc.x >= 0 && loc.x < cw && loc.y >= 0 && loc.y < ch;

        var oldHover = this._hoverIndex;
        this._hoverIndex = inside ? Math.floor((loc.y + this._scrollY) / ih) : -1;
        if (this._hoverIndex >= this._items.length) this._hoverIndex = -1;
        if (this._hoverIndex !== oldHover) this.refresh();

        if (inside && TouchInput.isTriggered() && this._hoverIndex >= 0) {
            this._selectedIndex = this._hoverIndex;
            if (this._onSelect) this._onSelect(this._items[this._selectedIndex], this._selectedIndex);
            this.refresh();
        }

        if (inside && TouchInput.wheelY) {
            var totalH = this._items.length * ih;
            this._scrollY += TouchInput.wheelY > 0 ? ih : -ih;
            this._scrollY = Math.max(0, Math.min(this._scrollY, Math.max(0, totalH - ch)));
            this.refresh();
        }
    };

    window.L2_List = L2_List;
})();

// ═══ ui/data/table.js ═══
/**
 * L2_Table - Data table with columns and rows.
 */
(function () {
    'use strict';

    function L2_Table() { this.initialize.apply(this, arguments); }
    L2_Table.prototype = Object.create(L2_Base.prototype);
    L2_Table.prototype.constructor = L2_Table;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {number} h
     * @param {object} [opts] - { columns: [{key, label, width}], rowHeight, onRowClick }
     */
    L2_Table.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._columns = opts.columns || [];
        this._rows = [];
        this._rowHeight = opts.rowHeight || L2_Theme.defaultItemHeight;
        this._headerHeight = 26;
        this._scrollY = 0;
        this._selectedRow = -1;
        this._hoverRow = -1;
        this._onRowClick = opts.onRowClick || null;
        this.refresh();
    };

    L2_Table.prototype.standardPadding = function () { return 4; };

    L2_Table.prototype.setRows = function (rows) {
        this._rows = rows || [];
        this._scrollY = 0;
        this._selectedRow = -1;
        this.markDirty();
    };

    L2_Table.prototype.refresh = function () {
        var c = this.bmp();
        var cw = this.cw(), ch = this.ch();
        var hh = this._headerHeight;
        var rh = this._rowHeight;

        // 只有背景层脏时才重绘背景和表头
        if (this.isLayerDirty('bg')) {
            c.clear();
            c.fillRect(0, 0, cw, ch, L2_Theme.bgDark);
            L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, 2, L2_Theme.borderDark);

            // Header
            c.fillRect(0, 0, cw, hh, '#1A1A30');
            c.fillRect(0, hh - 1, cw, 1, L2_Theme.borderDark);

            var colX = 0;
            var self = this;
            this._columns.forEach(function (col) {
                var colW = col.width || Math.floor(cw / self._columns.length);
                c.fontSize = L2_Theme.fontSmall;
                c.textColor = L2_Theme.textGold;
                c.drawText(col.label || col.key, colX + 4, 4, colW - 8, hh - 8, 'left');
                colX += colW;
            });
            this.markLayerClean('bg');
        }

        // 内容层需要重绘行数据
        if (this.isLayerDirty('content')) {
            // 重新绘制数据区域（清除之前的行数据）
            c.fillRect(0, hh, cw, ch - hh, L2_Theme.bgDark);
            
            // Rows
            var bodyH = ch - hh;
            var startIdx = Math.floor(this._scrollY / rh);
            var visCount = Math.ceil(bodyH / rh) + 1;

            for (var i = startIdx; i < Math.min(startIdx + visCount, this._rows.length); i++) {
                var ry = hh + i * rh - this._scrollY;
                if (ry + rh < hh || ry > ch) continue;

                if (i === this._selectedRow) {
                    c.fillRect(1, ry, cw - 2, rh, L2_Theme.selection);
                } else if (i === this._hoverRow) {
                    c.fillRect(1, ry, cw - 2, rh, L2_Theme.highlight);
                } else if (i % 2 === 1) {
                    // Alternating stripe
                    c.fillRect(1, ry, cw - 2, rh, 'rgba(255,255,255,0.02)');
                }

                c.fillRect(2, ry + rh - 1, cw - 4, 1, 'rgba(255,255,255,0.03)');

                var colX = 0;
                var row = this._rows[i];
                this._columns.forEach(function (col) {
                    var colW = col.width || Math.floor(cw / self._columns.length);
                    c.fontSize = L2_Theme.fontNormal;
                    c.textColor = L2_Theme.textWhite;
                    var val = row[col.key] !== undefined ? String(row[col.key]) : '';
                    c.drawText(val, colX + 4, ry + 2, colW - 8, rh - 4, 'left');
                    colX += colW;
                });
            }
            this.markLayerClean('content');
        }
    };

    L2_Table.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var loc = this.toLocal(TouchInput.x, TouchInput.y);
        var cw = this.cw(), ch = this.ch();
        var hh = this._headerHeight;
        var rh = this._rowHeight;
        var inside = loc.x >= 0 && loc.x < cw && loc.y >= hh && loc.y < ch;

        var oldHover = this._hoverRow;
        this._hoverRow = inside ? Math.floor((loc.y - hh + this._scrollY) / rh) : -1;
        if (this._hoverRow >= this._rows.length) this._hoverRow = -1;
        if (this._hoverRow !== oldHover) this.markDirty('content');

        if (inside && TouchInput.isTriggered() && this._hoverRow >= 0) {
            this._selectedRow = this._hoverRow;
            if (this._onRowClick) this._onRowClick(this._rows[this._selectedRow], this._selectedRow);
            this.markDirty('content');
        }

        if (inside && TouchInput.wheelY) {
            var totalH = this._rows.length * rh;
            var bodyH = ch - hh;
            var oldScrollY = this._scrollY;
            this._scrollY += TouchInput.wheelY > 0 ? rh : -rh;
            this._scrollY = Math.max(0, Math.min(this._scrollY, Math.max(0, totalH - bodyH)));
            if (this._scrollY !== oldScrollY) {
                this.markDirty('content');
            }
        }
    };

    window.L2_Table = L2_Table;
})();

// ═══ ui/data/card.js ═══
/**
 * L2_Card - Content card with optional header and actions area.
 */
(function () {
    'use strict';

    function L2_Card() { this.initialize.apply(this, arguments); }
    L2_Card.prototype = Object.create(L2_Base.prototype);
    L2_Card.prototype.constructor = L2_Card;

    L2_Card.prototype.initialize = function (x, y, w, h, opts) {
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        opts = opts || {};
        this._title = opts.title || '';
        this._body = opts.body || '';
        this._footer = opts.footer || '';
        this._hover = false;
        this._onClick = opts.onClick || null;
        this.refresh();
    };

    L2_Card.prototype.standardPadding = function () { return 4; };

    L2_Card.prototype.setContent = function (title, body, footer) {
        this._title = title || this._title;
        this._body = body || this._body;
        this._footer = footer || this._footer;
        this.markDirty();
    };

    L2_Card.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        L2_Theme.drawPanelBg(c, 0, 0, cw, ch);
        if (this._hover) {
            L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, L2_Theme.cornerRadius, L2_Theme.borderGold);
        }

        var yy = 8;
        if (this._title) {
            c.fontSize = L2_Theme.fontTitle;
            c.textColor = L2_Theme.textTitle;
            c.drawText(this._title, 10, yy, cw - 20, 20, 'left');
            yy += 24;
            c.fillRect(8, yy, cw - 16, 1, L2_Theme.borderDark);
            yy += 6;
        }

        if (this._body) {
            c.fontSize = L2_Theme.fontNormal;
            c.textColor = L2_Theme.textGray;
            c.drawText(this._body, 10, yy, cw - 20, ch - yy - 30, 'left');
        }

        if (this._footer) {
            c.fillRect(8, ch - 28, cw - 16, 1, L2_Theme.borderDark);
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textDim;
            c.drawText(this._footer, 10, ch - 22, cw - 20, 18, 'left');
        }
    };

    L2_Card.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var wasHover = this._hover;
        this._hover = this.isInside(TouchInput.x, TouchInput.y);
        if (this._hover !== wasHover) this.markDirty();
        if (this._hover && TouchInput.isTriggered() && this._onClick) this._onClick();
    };

    window.L2_Card = L2_Card;
})();

// ═══ ui/data/progress.js ═══
/**
 * L2_Progress - Progress bar (HP/MP/EXP/Loading).
 */
(function () {
    'use strict';

    function L2_Progress() { this.initialize.apply(this, arguments); }
    L2_Progress.prototype = Object.create(L2_Base.prototype);
    L2_Progress.prototype.constructor = L2_Progress;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { bgColor, fillColor, label, showText, showPercent, value, max, height }
     */
    L2_Progress.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        var h = opts.height || 18;
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this._bgColor = opts.bgColor || L2_Theme.hpBg;
        this._fillColor = opts.fillColor || L2_Theme.hpFill;
        this._value = opts.value || 0;
        this._maxValue = opts.max || 100;
        this._label = opts.label || '';
        this._showText = opts.showText !== false;
        this._showPercent = opts.showPercent || false;
        this.refresh();
    };

    L2_Progress.prototype.standardPadding = function () { return 0; };

    L2_Progress.prototype.setValue = function (val, max) {
        this._value = val;
        if (max !== undefined) this._maxValue = max;
        this.markDirty();
    };

    L2_Progress.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var ratio = this._maxValue > 0 ? this._value / this._maxValue : 0;
        L2_Theme.drawBar(c, 0, 0, cw, ch, ratio, this._bgColor, this._fillColor);
        if (this._showText) {
            c.fontSize = Math.max(ch - 4, 8);
            c.textColor = L2_Theme.textWhite;
            var text = this._showPercent
                ? Math.floor(ratio * 100) + '%'
                : (this._label ? this._label + '  ' : '') + this._value + ' / ' + this._maxValue;
            c.drawText(text, 4, 0, cw - 8, ch, 'left');
        }
    };

    window.L2_Progress = L2_Progress;
})();

// ═══ ui/data/tag.js ═══
/**
 * L2_Tag - Small label tag/badge.
 */
(function () {
    'use strict';

    function L2_Tag() { this.initialize.apply(this, arguments); }
    L2_Tag.prototype = Object.create(L2_Base.prototype);
    L2_Tag.prototype.constructor = L2_Tag;

    /**
     * @param {number} x
     * @param {number} y
     * @param {string} text
     * @param {object} [opts] - { color, bgColor, closable, onClose }
     */
    L2_Tag.prototype.initialize = function (x, y, text, opts) {
        opts = opts || {};
        var w = Math.max(text.length * 8 + 20 + (opts.closable ? 18 : 0), 40);
        L2_Base.prototype.initialize.call(this, x, y, w, 22 + 4);
        this._text = text;
        this._textColor = opts.color || L2_Theme.textWhite;
        this._bgColor = opts.bgColor || '#1A2A44';
        this._closable = opts.closable || false;
        this._onClose = opts.onClose || null;
        this._closeHover = false;
        this.refresh();
    };

    L2_Tag.prototype.standardPadding = function () { return 2; };

    L2_Tag.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        L2_Theme.fillRoundRect(c, 0, 0, cw, ch, ch / 2, this._bgColor);
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = this._textColor;
        c.drawText(this._text, 8, 0, cw - 16 - (this._closable ? 14 : 0), ch, 'left');

        if (this._closable) {
            var bx = cw - 16, by = (ch - 10) / 2;
            var color = this._closeHover ? L2_Theme.textRed : L2_Theme.textGray;
            var ctx = c._context;
            if (ctx) {
                ctx.save();
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(bx, by);
                ctx.lineTo(bx + 10, by + 10);
                ctx.moveTo(bx + 10, by);
                ctx.lineTo(bx, by + 10);
                ctx.stroke();
                ctx.restore();
                c._setDirty();
            }
        }
    };

    L2_Tag.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible || !this._closable) return;
        var cw = this.cw();
        var bx = this.x + this.padding + cw - 16;
        var by = this.y + this.padding;
        var mx = TouchInput.x, my = TouchInput.y;
        var wasHover = this._closeHover;
        this._closeHover = mx >= bx && mx <= bx + 14 && my >= by && my <= by + this.ch();
        if (this._closeHover !== wasHover) this.markDirty();
        if (this._closeHover && TouchInput.isTriggered() && this._onClose) this._onClose();
    };

    window.L2_Tag = L2_Tag;
})();

// ═══ ui/data/badge.js ═══
/**
 * L2_Badge - Small count or status dot displayed on another element.
 */
(function () {
    'use strict';

    function L2_Badge() { this.initialize.apply(this, arguments); }
    L2_Badge.prototype = Object.create(L2_Base.prototype);
    L2_Badge.prototype.constructor = L2_Badge;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { count, maxCount, dot, color, offset }
     */
    L2_Badge.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._count = opts.count != null ? opts.count : 0;
        this._maxCount = opts.maxCount || 99;
        this._dot = opts.dot || false;
        this._badgeColor = opts.color || L2_Theme.dangerColor;
        this._offset = opts.offset || { x: 0, y: 0 };
        var size = this._dot ? 10 : 22;
        L2_Base.prototype.initialize.call(this, x + this._offset.x, y + this._offset.y, size + 4, size + 4);
        this.refresh();
    };

    L2_Badge.prototype.standardPadding = function () { return 2; };

    L2_Badge.prototype.setCount = function (n) {
        if (this._count !== n) { this._count = n; this.markDirty(); }
    };

    L2_Badge.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        if (this._count <= 0 && !this._dot) return;
        var cw = this.cw(), ch = this.ch();
        var ctx = c._context;
        if (!ctx) return;

        ctx.save();
        if (this._dot) {
            var r = 4;
            ctx.fillStyle = this._badgeColor;
            ctx.beginPath();
            ctx.arc(cw / 2, ch / 2, r, 0, Math.PI * 2);
            ctx.fill();
        } else {
            var text = this._count > this._maxCount ? this._maxCount + '+' : String(this._count);
            var tw = Math.max(text.length * 7 + 6, 18);
            var bh = 16;
            var bx = (cw - tw) / 2, by = (ch - bh) / 2;
            ctx.fillStyle = this._badgeColor;
            L2_Theme.fillRoundRect(c, bx, by, tw, bh, bh / 2, this._badgeColor);
            c.fontSize = 11;
            c.textColor = '#FFFFFF';
            c.drawText(text, bx, by, tw, bh, 'center');
        }
        ctx.restore();
        c._setDirty();
    };

    window.L2_Badge = L2_Badge;
})();

// ═══ ui/data/avatar.js ═══
/**
 * L2_Avatar - Circular or square avatar with optional image/text/icon.
 */
(function () {
    'use strict';

    function L2_Avatar() { this.initialize.apply(this, arguments); }
    L2_Avatar.prototype = Object.create(L2_Base.prototype);
    L2_Avatar.prototype.constructor = L2_Avatar;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { size, shape, text, iconIndex, faceName, faceIndex, bgColor }
     */
    L2_Avatar.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._size = opts.size || L2_Theme.iconSize;
        this._shape = opts.shape || 'circle'; // 'circle' | 'square'
        this._avatarText = opts.text || '';
        this._iconIndex = opts.iconIndex != null ? opts.iconIndex : -1;
        this._faceName = opts.faceName || '';
        this._faceIndex = opts.faceIndex || 0;
        this._avatarBg = opts.bgColor || L2_Theme.primaryColor;
        L2_Base.prototype.initialize.call(this, x, y, this._size + 4, this._size + 4);
        if (this._faceName) {
            this._faceBitmap = ImageManager.loadFace(this._faceName);
            this._faceBitmap.addLoadListener(this.refresh.bind(this));
        }
        this.refresh();
    };

    L2_Avatar.prototype.standardPadding = function () { return 2; };

    L2_Avatar.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var s = this._size;
        var ctx = c._context;
        if (!ctx) return;

        ctx.save();
        if (this._shape === 'circle') {
            ctx.beginPath();
            ctx.arc(s / 2, s / 2, s / 2, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
        }

        // Background
        ctx.fillStyle = this._avatarBg;
        ctx.fillRect(0, 0, s, s);

        if (this._faceName && this._faceBitmap && this._faceBitmap.isReady()) {
            // Draw face from RMMV face sheet (144x144 per face, 4 cols)
            var fw = 144, fh = 144;
            var fx = (this._faceIndex % 4) * fw;
            var fy = Math.floor(this._faceIndex / 4) * fh;
            c.blt(this._faceBitmap, fx, fy, fw, fh, 0, 0, s, s);
        } else if (this._iconIndex >= 0) {
            // Draw icon centered
            var iconBitmap = ImageManager.loadSystem('IconSet');
            var pw = 32, ph = 32;
            var sx = (this._iconIndex % 16) * pw;
            var sy = Math.floor(this._iconIndex / 16) * ph;
            var dx = (s - pw) / 2, dy = (s - ph) / 2;
            c.blt(iconBitmap, sx, sy, pw, ph, dx, dy);
        } else if (this._avatarText) {
            // Draw text centered
            c.fontSize = Math.floor(s * 0.5);
            c.textColor = L2_Theme.textWhite;
            c.drawText(this._avatarText.charAt(0).toUpperCase(), 0, 0, s, s, 'center');
        }

        ctx.restore();
        c._setDirty();
    };

    window.L2_Avatar = L2_Avatar;
})();

// ═══ ui/data/collapse.js ═══
/**
 * L2_Collapse - Expandable/collapsible content panels.
 */
(function () {
    'use strict';

    function L2_Collapse() { this.initialize.apply(this, arguments); }
    L2_Collapse.prototype = Object.create(L2_Base.prototype);
    L2_Collapse.prototype.constructor = L2_Collapse;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { items: [{title, content, expanded}], accordion }
     */
    L2_Collapse.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        this._items = (opts.items || []).map(function (it) {
            return { title: it.title || '', content: it.content || '', expanded: !!it.expanded };
        });
        this._accordion = opts.accordion || false;
        this._headerH = L2_Theme.titleBarH;
        this._lineH = L2_Theme.fontNormal + 4;
        this._hoverIdx = -1;
        var h = this._calcHeight();
        L2_Base.prototype.initialize.call(this, x, y, w, h + 4);
        this.refresh();
    };

    L2_Collapse.prototype.standardPadding = function () { return 2; };

    L2_Collapse.prototype._calcHeight = function () {
        var h = 0;
        for (var i = 0; i < this._items.length; i++) {
            h += this._headerH;
            if (this._items[i].expanded) {
                var lines = this._wrapText(this._items[i].content);
                h += lines.length * this._lineH + 8;
            }
        }
        return Math.max(h, this._headerH);
    };

    L2_Collapse.prototype._wrapText = function (text) {
        var maxW = this.cw() - 20;
        return L2_Theme.wrapText(text, maxW, 7);
    };

    L2_Collapse.prototype.refresh = function () {
        var newH = this._calcHeight() + 4;
        if (this.height !== newH) {
            this.height = newH;
            this.createContents();
        }
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), yy = 0;

        for (var i = 0; i < this._items.length; i++) {
            var item = this._items[i];
            // Header bg
            var hBg = (this._hoverIdx === i) ? L2_Theme.bgLight : L2_Theme.bgPanel;
            c.fillRect(0, yy, cw, this._headerH, hBg);
            // Arrow
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textGold;
            var arrow = item.expanded ? '▼' : '▶';
            c.drawText(arrow, 6, yy, 14, this._headerH, 'left');
            // Title
            c.textColor = L2_Theme.textWhite;
            c.drawText(item.title, 22, yy, cw - 28, this._headerH, 'left');
            // Separator
            c.fillRect(0, yy + this._headerH - 1, cw, 1, L2_Theme.borderDark);
            yy += this._headerH;

            if (item.expanded) {
                var lines = this._wrapText(item.content);
                c.fontSize = L2_Theme.fontSmall;
                c.textColor = L2_Theme.textGray;
                for (var j = 0; j < lines.length; j++) {
                    c.drawText(lines[j], 10, yy + 4 + j * this._lineH, cw - 20, this._lineH, 'left');
                }
                yy += lines.length * this._lineH + 8;
            }
        }
    };

    L2_Collapse.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible || this._items.length === 0) return;
        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x - this.padding;
        var ly = my - this.y - this.padding;
        var oldHover = this._hoverIdx;
        this._hoverIdx = -1;

        var yy = 0;
        for (var i = 0; i < this._items.length; i++) {
            if (ly >= yy && ly < yy + this._headerH && lx >= 0 && lx < this.cw()) {
                this._hoverIdx = i;
            }
            yy += this._headerH;
            if (this._items[i].expanded) {
                var lines = this._wrapText(this._items[i].content);
                yy += lines.length * this._lineH + 8;
            }
        }
        if (this._hoverIdx !== oldHover) this.markDirty();

        if (TouchInput.isTriggered() && this._hoverIdx >= 0) {
            this._toggle(this._hoverIdx);
        }
    };

    L2_Collapse.prototype._toggle = function (idx) {
        if (this._accordion) {
            for (var i = 0; i < this._items.length; i++) {
                if (i !== idx) this._items[i].expanded = false;
            }
        }
        this._items[idx].expanded = !this._items[idx].expanded;
        this.markDirty();
    };

    window.L2_Collapse = L2_Collapse;
})();

// ═══ ui/data/tooltip.js ═══
/**
 * L2_Tooltip - Floating tooltip that shows near the mouse.
 */
(function () {
    'use strict';

    function L2_Tooltip() { this.initialize.apply(this, arguments); }
    L2_Tooltip.prototype = Object.create(L2_Base.prototype);
    L2_Tooltip.prototype.constructor = L2_Tooltip;

    L2_Tooltip.prototype.initialize = function () {
        L2_Base.prototype.initialize.call(this, 0, 0, 200, 60);
        this._tooltipText = '';
        this._lines = [];
        this._showTimer = 0;
        this._delay = 15; // frames before showing
        this.visible = false;
        this.refresh();
    };

    L2_Tooltip.prototype.standardPadding = function () { return 4; };

    /**
     * Show tooltip with the given text at mouse position.
     * @param {string} text
     */
    L2_Tooltip.prototype.show = function (text) {
        if (this._tooltipText === text && this.visible) return;
        this._tooltipText = text;
        this._lines = this._wrapText(text);
        this._showTimer = this._delay;
        this._resize();
        this.refresh();
    };

    L2_Tooltip.prototype.hide = function () {
        this.visible = false;
        this._tooltipText = '';
        this._showTimer = 0;
    };

    L2_Tooltip.prototype._wrapText = function (text) {
        return L2_Theme.wrapTextByChars(text, 30);
    };

    L2_Tooltip.prototype._resize = function () {
        var lineH = 18;
        var maxW = 40;
        for (var i = 0; i < this._lines.length; i++) {
            maxW = Math.max(maxW, this._lines[i].length * 7 + 16);
        }
        var newW = Math.min(maxW, 300);
        var newH = this._lines.length * lineH + 12;
        if (this.width !== newW || this.height !== newH) {
            this.width = newW;
            this.height = newH;
            this.createContents();
        }
    };

    L2_Tooltip.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        // Background
        L2_Theme.fillRoundRect(c, 0, 0, cw, ch, 4, 'rgba(10,15,30,0.92)');
        L2_Theme.strokeRoundRect(c, 0, 0, cw, ch, 4, L2_Theme.borderLight);

        // Text
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = L2_Theme.textWhite;
        var lineH = 18;
        for (var i = 0; i < this._lines.length; i++) {
            c.drawText(this._lines[i], 6, 4 + i * lineH, cw - 12, lineH, 'left');
        }
    };

    L2_Tooltip.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this._tooltipText) return;
        if (this._showTimer > 0) {
            this._showTimer--;
            if (this._showTimer <= 0) {
                this.visible = true;
            }
        }
        if (this.visible) {
            // Follow mouse with offset
            var mx = TouchInput.x + 12;
            var my = TouchInput.y + 16;
            var gw = Graphics.boxWidth || 816;
            var gh = Graphics.boxHeight || 624;
            if (mx + this.width > gw) mx = TouchInput.x - this.width - 4;
            if (my + this.height > gh) my = TouchInput.y - this.height - 4;
            this.x = mx;
            this.y = my;
        }
    };

    window.L2_Tooltip = L2_Tooltip;
})();

// ═══ ui/data/tree.js ═══
/**
 * L2_Tree - Hierarchical tree view with expand/collapse.
 */
(function () {
    'use strict';

    function L2_Tree() { this.initialize.apply(this, arguments); }
    L2_Tree.prototype = Object.create(L2_Base.prototype);
    L2_Tree.prototype.constructor = L2_Tree;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {number} h
     * @param {object} [opts] - { data: [{label, children, expanded, iconIndex}], onSelect }
     */
    L2_Tree.prototype.initialize = function (x, y, w, h, opts) {
        opts = opts || {};
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this._data = opts.data || [];
        this._onSelect = opts.onSelect || null;
        this._nodeH = L2_Theme.defaultItemHeight;
        this._indent = 18;
        this._scrollY = 0;
        this._hoverNode = null;
        this._selectedNode = null;
        this._flatNodes = [];
        this._rebuildFlat();
        this.refresh();
    };

    L2_Tree.prototype._rebuildFlat = function () {
        this._flatNodes = [];
        var self = this;
        function walk(nodes, depth) {
            for (var i = 0; i < nodes.length; i++) {
                var n = nodes[i];
                if (n.expanded === undefined) n.expanded = false;
                self._flatNodes.push({ node: n, depth: depth });
                if (n.children && n.children.length > 0 && n.expanded) {
                    walk(n.children, depth + 1);
                }
            }
        }
        walk(this._data, 0);
    };

    L2_Tree.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();

        c.fillRect(0, 0, cw, ch, L2_Theme.bgDark);
        c.fontSize = L2_Theme.fontSmall;

        var startIdx = Math.floor(this._scrollY / this._nodeH);
        var visCount = Math.ceil(ch / this._nodeH) + 1;

        for (var i = startIdx; i < Math.min(startIdx + visCount, this._flatNodes.length); i++) {
            var item = this._flatNodes[i];
            var ny = i * this._nodeH - this._scrollY;
            var nx = item.depth * this._indent;

            // Hover/select bg
            if (this._selectedNode === item.node) {
                c.fillRect(0, ny, cw, this._nodeH, L2_Theme.primaryColor + '44');
            } else if (this._hoverNode === item.node) {
                c.fillRect(0, ny, cw, this._nodeH, L2_Theme.bgLight);
            }

            // Expand arrow
            if (item.node.children && item.node.children.length > 0) {
                c.textColor = L2_Theme.textGold;
                var arrow = item.node.expanded ? '▼' : '▶';
                c.drawText(arrow, nx + 2, ny, 14, this._nodeH, 'left');
            }

            // Icon
            var textX = nx + 18;
            if (item.node.iconIndex != null && item.node.iconIndex >= 0) {
                this._drawIcon(c, item.node.iconIndex, textX, ny + (this._nodeH - 16) / 2);
                textX += 20;
            }

            // Label
            c.textColor = this._selectedNode === item.node ? L2_Theme.textGold : L2_Theme.textWhite;
            c.drawText(item.node.label || '', textX, ny, cw - textX - 4, this._nodeH, 'left');
        }

        // Scrollbar
        var totalH = this._flatNodes.length * this._nodeH;
        if (totalH > ch) {
            var sbW = L2_Theme.scrollbarWidth;
            var barH = Math.max(ch * ch / totalH, 20);
            var barY = (this._scrollY / (totalH - ch)) * (ch - barH);
            c.fillRect(cw - sbW, barY, sbW, barH, L2_Theme.textGray + '66');
        }
    };

    L2_Tree.prototype._drawIcon = function (c, iconIndex, dx, dy) {
        var bitmap = ImageManager.loadSystem('IconSet');
        if (!bitmap || !bitmap.isReady()) return;
        var pw = 32, ph = 32;
        var sx = (iconIndex % 16) * pw;
        var sy = Math.floor(iconIndex / 16) * ph;
        c.blt(bitmap, sx, sy, pw, ph, dx, dy, 16, 16);
    };

    L2_Tree.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x - this.padding;
        var ly = my - this.y - this.padding;
        var inside = lx >= 0 && lx < this.cw() && ly >= 0 && ly < this.ch();

        // Scroll
        if (inside && TouchInput.wheelY) {
            var totalH = this._flatNodes.length * this._nodeH;
            this._scrollY = Math.max(0, Math.min(this._scrollY + TouchInput.wheelY * 20, totalH - this.ch()));
            this.refresh();
        }

        // Hover
        var oldHover = this._hoverNode;
        this._hoverNode = null;
        if (inside) {
            var idx = Math.floor((ly + this._scrollY) / this._nodeH);
            if (idx >= 0 && idx < this._flatNodes.length) {
                this._hoverNode = this._flatNodes[idx].node;
            }
        }
        if (this._hoverNode !== oldHover) this.refresh();

        // Click
        if (inside && TouchInput.isTriggered() && this._hoverNode) {
            var node = this._hoverNode;
            if (node.children && node.children.length > 0) {
                node.expanded = !node.expanded;
                this._rebuildFlat();
            }
            this._selectedNode = node;
            if (this._onSelect) this._onSelect(node);
            this.markDirty();
        }
    };

    window.L2_Tree = L2_Tree;
})();

// ═══ ui/data/statistic.js ═══
/**
 * L2_Statistic - Display a statistic value with title and optional prefix/suffix.
 */
(function () {
    'use strict';

    function L2_Statistic() { this.initialize.apply(this, arguments); }
    L2_Statistic.prototype = Object.create(L2_Base.prototype);
    L2_Statistic.prototype.constructor = L2_Statistic;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { title, value, prefix, suffix, color, trend }
     */
    L2_Statistic.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._title = opts.title || '';
        this._value = opts.value != null ? opts.value : 0;
        this._prefix = opts.prefix || '';
        this._suffix = opts.suffix || '';
        this._valueColor = opts.color || L2_Theme.textWhite;
        this._trend = opts.trend || ''; // 'up' | 'down' | ''
        var w = opts.width || 120;
        L2_Base.prototype.initialize.call(this, x, y, w, 56);
        this.refresh();
    };

    L2_Statistic.prototype.standardPadding = function () { return 4; };

    L2_Statistic.prototype.setValue = function (v) {
        if (this._value !== v) { this._value = v; this.markDirty(); }
    };

    L2_Statistic.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw();

        // Title
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = L2_Theme.textGray;
        c.drawText(this._title, 0, 0, cw, 18, 'left');

        // Value line
        var valStr = this._prefix + String(this._value) + this._suffix;
        c.fontSize = 22;
        this._valueColor = this._valueColor || L2_Theme.textWhite;
        if (this._trend === 'up') {
            c.textColor = L2_Theme.successColor;
        } else if (this._trend === 'down') {
            c.textColor = L2_Theme.dangerColor;
        } else {
            c.textColor = this._valueColor;
        }
        c.drawText(valStr, 0, 20, cw, 28, 'left');

        // Trend arrow
        if (this._trend === 'up') {
            c.textColor = L2_Theme.successColor;
            c.drawText('↑', cw - 20, 20, 20, 28, 'right');
        } else if (this._trend === 'down') {
            c.textColor = L2_Theme.dangerColor;
            c.drawText('↓', cw - 20, 20, 20, 28, 'right');
        }
    };

    window.L2_Statistic = L2_Statistic;
})();

// ═══ ui/data/empty.js ═══
/**
 * L2_Empty - Empty state placeholder with icon and message.
 */
(function () {
    'use strict';

    function L2_Empty() { this.initialize.apply(this, arguments); }
    L2_Empty.prototype = Object.create(L2_Base.prototype);
    L2_Empty.prototype.constructor = L2_Empty;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { text, iconIndex }
     */
    L2_Empty.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        this._emptyText = opts.text || '暂无数据';
        this._iconIndex = opts.iconIndex != null ? opts.iconIndex : -1;
        var h = this._iconIndex >= 0 ? 80 : 50;
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this.refresh();
    };

    L2_Empty.prototype.standardPadding = function () { return 4; };

    L2_Empty.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var yy = 0;

        // Icon
        if (this._iconIndex >= 0) {
            var bitmap = ImageManager.loadSystem('IconSet');
            if (bitmap && bitmap.isReady()) {
                var pw = 32, ph = 32;
                var sx = (this._iconIndex % 16) * pw;
                var sy = Math.floor(this._iconIndex / 16) * ph;
                c.blt(bitmap, sx, sy, pw, ph, (cw - 32) / 2, yy + 4);
            }
            yy += 40;
        }

        // Text
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textGray;
        c.drawText(this._emptyText, 0, yy, cw, 24, 'center');
    };

    window.L2_Empty = L2_Empty;
})();

// ═══ ui/data/loading.js ═══
/**
 * L2_Loading - Animated loading spinner.
 */
(function () {
    'use strict';

    function L2_Loading() { this.initialize.apply(this, arguments); }
    L2_Loading.prototype = Object.create(L2_Base.prototype);
    L2_Loading.prototype.constructor = L2_Loading;

    /**
     * @param {number} x
     * @param {number} y
     * @param {object} [opts] - { size, text, color }
     */
    L2_Loading.prototype.initialize = function (x, y, opts) {
        opts = opts || {};
        this._spinSize = opts.size || 24;
        this._loadingText = opts.text || '';
        this._spinColor = opts.color || L2_Theme.primaryColor;
        this._angle = 0;
        var w = this._loadingText ? this._spinSize + 8 + this._loadingText.length * 8 + 8 : this._spinSize + 8;
        var h = Math.max(this._spinSize + 8, 28);
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this.refresh();
    };

    L2_Loading.prototype.standardPadding = function () { return 4; };

    L2_Loading.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var cw = this.cw(), ch = this.ch();
        var ctx = c._context;
        if (!ctx) return;

        var cx = this._spinSize / 2;
        var cy = ch / 2;
        var r = this._spinSize / 2 - 2;

        ctx.save();
        // Background circle
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.strokeStyle = L2_Theme.borderDark;
        ctx.lineWidth = 3;
        ctx.stroke();

        // Spinning arc
        ctx.beginPath();
        ctx.arc(cx, cy, r, this._angle, this._angle + Math.PI * 0.75);
        ctx.strokeStyle = this._spinColor;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();
        ctx.restore();

        // Text
        if (this._loadingText) {
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textGray;
            c.drawText(this._loadingText, this._spinSize + 6, 0, cw - this._spinSize - 8, ch, 'left');
        }
        c._setDirty();
    };

    L2_Loading.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;
        this._angle += 0.08;
        if (this._angle > Math.PI * 2) this._angle -= Math.PI * 2;
        this.markDirty();
    };

    window.L2_Loading = L2_Loading;
})();

// ═══ ui/feedback/dialog.js ═══
/**
 * L2_Dialog - Modal dialog with title, content, and action buttons.
 */
(function () {
    'use strict';

    function L2_Dialog() { this.initialize.apply(this, arguments); }
    L2_Dialog.prototype = Object.create(L2_Base.prototype);
    L2_Dialog.prototype.constructor = L2_Dialog;

    /**
     * @param {object} [opts] - { title, content, width, buttons: [{text, type, onClick}], closable, onClose }
     */
    L2_Dialog.prototype.initialize = function (opts) {
        opts = opts || {};
        this._title = opts.title || '';
        this._content = opts.content || '';
        this._closable = opts.closable !== false;
        this._onClose = opts.onClose || null;
        this._buttons = opts.buttons || [];
        this._closeHover = false;
        this._hoverBtn = -1;

        var dw = opts.width || 360;
        this._contentLines = L2_Theme.wrapText(this._content, dw - 40, 7);
        var titleH = this._title ? 36 : 0;
        var contentH = Math.max(this._contentLines.length * 20 + 16, 40);
        var btnH = this._buttons.length > 0 ? 44 : 0;
        var dh = titleH + contentH + btnH + 8;

        var gw = Graphics.boxWidth || 816;
        var gh = Graphics.boxHeight || 624;
        var dx = (gw - dw) / 2;
        var dy = (gh - dh) / 2;

        L2_Base.prototype.initialize.call(this, dx, dy, dw, dh);
        this._titleH = titleH;
        this._contentH = contentH;
        this._btnH = btnH;
        this.refresh();
    };

    L2_Dialog.prototype.standardPadding = function () { return 0; };

    L2_Dialog.prototype._wrapText = function (text, maxW) {
        return L2_Theme.wrapText(text, maxW, 7);
    };

    L2_Dialog.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var w = this.width, h = this.height;

        // Overlay handled externally or by parent scene
        // Dialog body
        L2_Theme.drawPanelBg(c, 0, 0, w, h);

        var yy = 0;
        // Title bar
        if (this._title) {
            L2_Theme.drawTitleBar(c, 0, 0, w, this._titleH, this._title);
            if (this._closable) {
                L2_Theme.drawCloseBtn(c, w - 28, 8, this._closeHover);
            }
            yy = this._titleH;
        }

        // Content
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        for (var i = 0; i < this._contentLines.length; i++) {
            c.drawText(this._contentLines[i], 20, yy + 8 + i * 20, w - 40, 20, 'left');
        }
        yy += this._contentH;

        // Buttons
        if (this._buttons.length > 0) {
            var btnW = 80, btnH = 30, gap = 12;
            var totalBtnW = this._buttons.length * btnW + (this._buttons.length - 1) * gap;
            var bx = (w - totalBtnW) / 2;

            for (var j = 0; j < this._buttons.length; j++) {
                var btn = this._buttons[j];
                var hover = this._hoverBtn === j;
                var color = L2_Theme.primaryColor;
                if (btn.type === 'danger') color = L2_Theme.dangerColor;
                else if (btn.type === 'default') color = L2_Theme.bgLight;

                var bg = hover ? L2_Theme.lighten(color, 0.15) : color;
                L2_Theme.fillRoundRect(c, bx, yy + 6, btnW, btnH, 4, bg);

                c.fontSize = L2_Theme.fontSmall;
                c.textColor = L2_Theme.textWhite;
                c.drawText(btn.text || '', bx, yy + 6, btnW, btnH, 'center');
                bx += btnW + gap;
            }
        }
    };

    L2_Dialog.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x, ly = my - this.y;
        var w = this.width;

        // Close button hover
        if (this._closable && this._title) {
            var wasCloseHover = this._closeHover;
            this._closeHover = lx >= w - 32 && lx <= w && ly >= 4 && ly <= 32;
            if (this._closeHover !== wasCloseHover) this.refresh();
            if (this._closeHover && TouchInput.isTriggered()) {
                this.close();
                return;
            }
        }

        // Button hover and click
        if (this._buttons.length > 0) {
            var btnW = 80, btnH2 = 30, gap = 12;
            var totalBtnW = this._buttons.length * btnW + (this._buttons.length - 1) * gap;
            var bx0 = (w - totalBtnW) / 2;
            var byy = this._titleH + this._contentH + 6;
            var oldHover = this._hoverBtn;
            this._hoverBtn = -1;

            for (var j = 0; j < this._buttons.length; j++) {
                var bbx = bx0 + j * (btnW + gap);
                if (lx >= bbx && lx <= bbx + btnW && ly >= byy && ly <= byy + btnH2) {
                    this._hoverBtn = j;
                }
            }
            if (this._hoverBtn !== oldHover) this.refresh();

            if (TouchInput.isTriggered() && this._hoverBtn >= 0) {
                var onClick = this._buttons[this._hoverBtn].onClick;
                if (onClick) onClick();
            }
        }

        // ESC to close
        if (this._closable && Input.isTriggered('cancel')) {
            this.close();
        }
    };

    L2_Dialog.prototype.close = function () {
        if (this._closed) return;
        this._closed = true;
        this.visible = false;
        if (this.parent && this.parent.removeChild) {
            this.parent.removeChild(this);
        }
        var onClose = this._onClose;
        // 清理引用
        this._onClose = null;
        this._buttons = null;
        if (onClose) onClose();
    };

    // Static convenience methods
    L2_Dialog.alert = function (title, content, onOk) {
        var d = new L2_Dialog({
            title: title,
            content: content,
            buttons: [{ text: '确定', type: 'primary', onClick: function () { d.close(); if (onOk) onOk(); } }]
        });
        if (SceneManager._scene) SceneManager._scene.addChild(d);
        return d;
    };

    L2_Dialog.confirm = function (title, content, onOk, onCancel) {
        var d = new L2_Dialog({
            title: title,
            content: content,
            buttons: [
                { text: '确定', type: 'primary', onClick: function () { d.close(); if (onOk) onOk(); } },
                { text: '取消', type: 'default', onClick: function () { d.close(); if (onCancel) onCancel(); } }
            ]
        });
        if (SceneManager._scene) SceneManager._scene.addChild(d);
        return d;
    };

    window.L2_Dialog = L2_Dialog;
})();

// ═══ ui/feedback/drawer.js ═══
/**
 * L2_Drawer - Slide-in panel from edge of screen.
 */
(function () {
    'use strict';

    function L2_Drawer() { this.initialize.apply(this, arguments); }
    L2_Drawer.prototype = Object.create(L2_Base.prototype);
    L2_Drawer.prototype.constructor = L2_Drawer;

    /**
     * @param {object} [opts] - { title, width, placement, closable, onClose }
     */
    L2_Drawer.prototype.initialize = function (opts) {
        opts = opts || {};
        this._title = opts.title || '';
        this._drawerWidth = opts.width || 280;
        this._placement = opts.placement || 'right'; // 'left' | 'right'
        this._closable = opts.closable !== false;
        this._onClose = opts.onClose || null;
        this._closeHover = false;
        this._slideProgress = 0; // 0 to 1
        this._opening = false;
        this._closing = false;
        this._titleH = this._title ? 36 : 0;
        this._children = [];

        var gw = Graphics.boxWidth || 816;
        var gh = Graphics.boxHeight || 624;
        var dx = this._placement === 'right' ? gw : -this._drawerWidth;
        L2_Base.prototype.initialize.call(this, dx, 0, this._drawerWidth, gh);
        this._targetX = this._placement === 'right' ? gw - this._drawerWidth : 0;
        this._hiddenX = this._placement === 'right' ? gw : -this._drawerWidth;
        this.refresh();
    };

    L2_Drawer.prototype.standardPadding = function () { return 0; };

    L2_Drawer.prototype.open = function () {
        this._opening = true;
        this._closing = false;
        this.visible = true;
    };

    L2_Drawer.prototype.close = function () {
        this._closing = true;
        this._opening = false;
    };

    L2_Drawer.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var w = this.width, h = this.height;

        // Background
        c.fillRect(0, 0, w, h, L2_Theme.bgPanel);
        // Border on the open side
        if (this._placement === 'right') {
            c.fillRect(0, 0, 1, h, L2_Theme.borderLight);
        } else {
            c.fillRect(w - 1, 0, 1, h, L2_Theme.borderLight);
        }

        // Title bar
        if (this._title) {
            L2_Theme.drawTitleBar(c, 0, 0, w, this._titleH, this._title);
            if (this._closable) {
                L2_Theme.drawCloseBtn(c, w - 28, 8, this._closeHover);
            }
        }
    };

    /** Returns the Y offset for content added to the drawer. */
    L2_Drawer.prototype.contentY = function () {
        return this._titleH + 8;
    };

    L2_Drawer.prototype.addContent = function (child) {
        if (!child) return;
        this._children.push(child);
        this.addChild(child);
        // 调整子元素位置以适应抽屉内容区域
        if (child.y < this.contentY()) {
            child.y = this.contentY();
        }
    };

    L2_Drawer.prototype.removeContent = function (child) {
        if (!child) return;
        var idx = this._children.indexOf(child);
        if (idx >= 0) {
            this._children.splice(idx, 1);
            if (child.parent === this) {
                this.removeChild(child);
            }
        }
    };

    L2_Drawer.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        // Slide animation
        var speed = 0.12;
        if (this._opening) {
            this._slideProgress = Math.min(this._slideProgress + speed, 1);
            this.x = this._hiddenX + (this._targetX - this._hiddenX) * this._easeOut(this._slideProgress);
            if (this._slideProgress >= 1) this._opening = false;
        } else if (this._closing) {
            this._slideProgress = Math.max(this._slideProgress - speed, 0);
            this.x = this._hiddenX + (this._targetX - this._hiddenX) * this._easeOut(this._slideProgress);
            if (this._slideProgress <= 0) {
                this._closing = false;
                this.visible = false;
                if (this._onClose) this._onClose();
            }
        }

        // Close button
        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x, ly = my - this.y;
        if (this._closable && this._title) {
            var wasHover = this._closeHover;
            this._closeHover = lx >= this.width - 32 && lx <= this.width && ly >= 4 && ly <= 32;
            if (this._closeHover !== wasHover) this.markDirty();
            if (this._closeHover && TouchInput.isTriggered()) {
                this.close();
                return;
            }
        }

        // ESC to close
        if (this._closable && Input.isTriggered('cancel')) {
            this.close();
        }
    };

    L2_Drawer.prototype._easeOut = function (t) {
        return 1 - Math.pow(1 - t, 3);
    };

    window.L2_Drawer = L2_Drawer;
})();

// ═══ ui/feedback/message.js ═══
/**
 * L2_Message - Temporary top-center message bar (like toast at top).
 */
(function () {
    'use strict';

    var _messageQueue = [];
    var _activeMessages = [];
    var _maxVisible = 5;
    var _msgIdCounter = 0;
    var _poolName = 'L2_Message';

    function L2_Message() { this.initialize.apply(this, arguments); }
    L2_Message.prototype = Object.create(L2_Base.prototype);
    L2_Message.prototype.constructor = L2_Message;

    /**
     * @param {string} text
     * @param {object} [opts] - { type, duration }
     */
    L2_Message.prototype.initialize = function (text, opts) {
        opts = opts || {};
        this._msgId = ++_msgIdCounter;
        this._msgText = text || '';
        this._msgType = opts.type || 'info'; // 'info' | 'success' | 'warning' | 'error'
        this._duration = opts.duration || 120; // frames
        this._timer = this._duration;
        this._fadeOut = false;
        this._disposed = false;
        this._pooled = false;

        var tw = Math.max(text.length * 8 + 40, 120);
        var gw = Graphics.boxWidth || 816;
        L2_Base.prototype.initialize.call(this, (gw - tw) / 2, -30, tw, 30);
        this._targetY = 10;
        this.refresh();
    };

    L2_Message.prototype.standardPadding = function () { return 0; };

    L2_Message.prototype._typeColor = function () {
        switch (this._msgType) {
            case 'success': return L2_Theme.successColor;
            case 'warning': return L2_Theme.warningColor;
            case 'error': return L2_Theme.dangerColor;
            default: return L2_Theme.primaryColor;
        }
    };

    L2_Message.prototype._typeIcon = function () {
        switch (this._msgType) {
            case 'success': return '✓';
            case 'warning': return '!';
            case 'error': return '✕';
            default: return 'i';
        }
    };

    L2_Message.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var w = this.width, h = this.height;

        // Background
        L2_Theme.fillRoundRect(c, 0, 0, w, h, 4, 'rgba(20,30,50,0.95)');
        // Left accent
        var accentColor = this._typeColor();
        c.fillRect(0, 0, 3, h, accentColor);

        // Icon
        c.fontSize = 13;
        c.textColor = accentColor;
        c.drawText(this._typeIcon(), 10, 0, 16, h, 'center');

        // Text
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._msgText, 30, 0, w - 40, h, 'left');
    };

    L2_Message.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        // Slide in
        if (this.y < this._targetY) {
            this.y = Math.min(this.y + 4, this._targetY);
        }

        // Timer
        this._timer--;
        if (this._timer <= 0 && !this._fadeOut) {
            this._fadeOut = true;
        }

        // Fade out
        if (this._fadeOut) {
            this.opacity -= 8;
            if (this.opacity <= 0) {
                this._dispose();
            }
        }
    };

    function _repositionMessages() {
        // 清理已处置的消息
        _activeMessages = _activeMessages.filter(function (m) { return !m._disposed; });
        var yy = 10;
        for (var i = 0; i < _activeMessages.length; i++) {
            _activeMessages[i]._targetY = yy;
            yy += _activeMessages[i].height + 6;
        }
    }

    L2_Message.prototype._dispose = function () {
        if (this._disposed) return;
        this._disposed = true;
        this.visible = false;
        if (this.parent) this.parent.removeChild(this);
        var idx = _activeMessages.indexOf(this);
        if (idx >= 0) _activeMessages.splice(idx, 1);
        
        // 重置对象以便复用
        this._msgText = null;
        this._onChange = null;
        this.opacity = 255;
        
        _repositionMessages();
        
        // 返回对象池
        if (!this._pooled) {
            L2_Theme.release(_poolName, this, L2_Message._reset);
        }
    };

    /** Reset object for pool reuse */
    L2_Message._reset = function (msg) {
        msg._pooled = true;
        msg._msgText = '';
        msg._msgType = 'info';
        msg._duration = 120;
        msg._timer = 0;
        msg._fadeOut = false;
        msg._disposed = false;
        msg._targetY = 10;
        msg.visible = false;
        msg.opacity = 255;
        msg.y = -30;
        msg.parent = null;
        msg._dirty = true;
        msg._dirtyLayers = { bg: true, content: true };
    };

    /** 手动关闭并清理 */
    L2_Message.prototype.close = function () {
        this._fadeOut = true;
    };

    // Static API
    L2_Message.show = function (text, type, duration) {
        // 限制最大数量，自动清理最旧的消息
        while (_activeMessages.length >= _maxVisible) {
            var oldest = _activeMessages[0];
            if (oldest && oldest._dispose) oldest._dispose();
            else _activeMessages.shift();
        }
        
        // 从对象池获取或创建新实例
        var msg = L2_Theme.acquire(_poolName, function () {
            return new L2_Message(text, { type: type, duration: duration });
        });
        
        // 如果是池中的对象，需要重新初始化
        if (msg._pooled) {
            msg._pooled = false;
            msg._msgText = text || '';
            msg._msgType = type || 'info';
            msg._duration = duration || 120;
            msg._timer = msg._duration;
            msg._fadeOut = false;
            msg._disposed = false;
            msg._msgId = ++_msgIdCounter;
            
            var tw = Math.max((text || '').length * 8 + 40, 120);
            var gw = Graphics.boxWidth || 816;
            msg.x = (gw - tw) / 2;
            msg.y = -30;
            msg.width = tw;
            msg.height = 30;
            msg._targetY = 10;
            msg.visible = true;
            msg.opacity = 255;
            msg._dirty = true;
            msg._dirtyLayers = { bg: true, content: true };
        }
        
        _activeMessages.push(msg);
        _repositionMessages();
        if (SceneManager._scene && SceneManager._scene.addChild) {
            SceneManager._scene.addChild(msg);
        }
        msg.visible = true;
        msg.opacity = 255;
        return msg;
    };

    L2_Message.info = function (text, duration) { return L2_Message.show(text, 'info', duration); };
    L2_Message.success = function (text, duration) { return L2_Message.show(text, 'success', duration); };
    L2_Message.warning = function (text, duration) { return L2_Message.show(text, 'warning', duration); };
    L2_Message.error = function (text, duration) { return L2_Message.show(text, 'error', duration); };

    window.L2_Message = L2_Message;
})();

// ═══ ui/feedback/notification.js ═══
/**
 * L2_Notification - Corner notification popup with title and content.
 */
(function () {
    'use strict';

    var _activeNotifs = [];
    var _notifIdCounter = 0;
    var _maxVisible = 5;
    var _poolName = 'L2_Notification';

    function L2_Notification() { this.initialize.apply(this, arguments); }
    L2_Notification.prototype = Object.create(L2_Base.prototype);
    L2_Notification.prototype.constructor = L2_Notification;

    /**
     * @param {object} [opts] - { title, content, type, duration, placement, closable, onClose }
     */
    L2_Notification.prototype.initialize = function (opts) {
        opts = opts || {};
        this._notifId = ++_notifIdCounter;
        this._nTitle = opts.title || '';
        this._nContent = opts.content || '';
        this._nType = opts.type || 'info';
        this._duration = opts.duration || 180; // frames (~3s)
        this._placement = opts.placement || 'topRight';
        this._closable = opts.closable !== false;
        this._onClose = opts.onClose || null;
        this._timer = this._duration;
        this._fadeOut = false;
        this._closeHover = false;
        this._pooled = false;
        this._disposed = false;

        var nw = 280;
        var contentLines = this._wrapText(this._nContent, nw - 30);
        this._contentLines = contentLines;
        var nh = 24 + contentLines.length * 18 + 16;

        var gw = Graphics.boxWidth || 816;
        var startX = this._placement.indexOf('Right') >= 0 ? gw : -nw;
        L2_Base.prototype.initialize.call(this, startX, 0, nw, nh);
        this._targetX = this._placement.indexOf('Right') >= 0 ? gw - nw - 12 : 12;
        this.refresh();
    };

    L2_Notification.prototype.standardPadding = function () { return 0; };

    L2_Notification.prototype._wrapText = function (text, maxW) {
        return L2_Theme.wrapText(text, maxW, 7);
    };

    L2_Notification.prototype._typeColor = function () {
        switch (this._nType) {
            case 'success': return L2_Theme.successColor;
            case 'warning': return L2_Theme.warningColor;
            case 'error': return L2_Theme.dangerColor;
            default: return L2_Theme.primaryColor;
        }
    };

    L2_Notification.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var w = this.width, h = this.height;

        // Background
        L2_Theme.fillRoundRect(c, 0, 0, w, h, 6, 'rgba(15,22,40,0.95)');
        L2_Theme.strokeRoundRect(c, 0, 0, w, h, 6, L2_Theme.borderLight);

        // Left accent
        c.fillRect(0, 6, 3, h - 12, this._typeColor());

        // Title
        c.fontSize = L2_Theme.fontNormal;
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._nTitle, 12, 8, w - 40, 20, 'left');

        // Close button
        if (this._closable) {
            L2_Theme.drawCloseBtn(c, w - 22, 8, this._closeHover);
        }

        // Content
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = L2_Theme.textGray;
        for (var i = 0; i < this._contentLines.length; i++) {
            c.drawText(this._contentLines[i], 12, 30 + i * 18, w - 24, 18, 'left');
        }
    };

    L2_Notification.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        // Slide in
        var speed = 6;
        if (this._placement.indexOf('Right') >= 0) {
            if (this.x > this._targetX) this.x = Math.max(this.x - speed * 3, this._targetX);
        } else {
            if (this.x < this._targetX) this.x = Math.min(this.x + speed * 3, this._targetX);
        }

        // Close button hover
        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x, ly = my - this.y;
        if (this._closable) {
            var wasHover = this._closeHover;
            this._closeHover = lx >= this.width - 26 && lx <= this.width - 4 && ly >= 4 && ly <= 24;
            if (this._closeHover !== wasHover) this.refresh();
            if (this._closeHover && TouchInput.isTriggered()) {
                this._dismiss();
                return;
            }
        }

        // Timer
        if (this._duration > 0) {
            this._timer--;
            if (this._timer <= 0 && !this._fadeOut) this._fadeOut = true;
        }

        // Fade out
        if (this._fadeOut) {
            this.opacity -= 6;
            if (this.opacity <= 0) this._dismiss();
        }
    };

    L2_Notification.prototype._dismiss = function () {
        if (this._disposed) return;
        this._disposed = true;
        this.visible = false;
        if (this.parent) this.parent.removeChild(this);
        var idx = _activeNotifs.indexOf(this);
        if (idx >= 0) _activeNotifs.splice(idx, 1);
        _repositionNotifs();
        if (this._onClose) this._onClose();
        // 清理引用
        this._nTitle = null;
        this._nContent = null;
        this._onClose = null;
        this._contentLines = null;
        
        // 返回对象池
        if (!this._pooled) {
            L2_Theme.release(_poolName, this, L2_Notification._reset);
        }
    };

    /** Reset object for pool reuse */
    L2_Notification._reset = function (notif) {
        notif._pooled = true;
        notif._nTitle = '';
        notif._nContent = '';
        notif._nType = 'info';
        notif._duration = 180;
        notif._placement = 'topRight';
        notif._closable = true;
        notif._onClose = null;
        notif._timer = 0;
        notif._fadeOut = false;
        notif._closeHover = false;
        notif._disposed = false;
        notif._contentLines = null;
        notif.visible = false;
        notif.opacity = 255;
        notif.parent = null;
        notif._dirty = true;
    };

    function _repositionNotifs() {
        // 清理已处置的通知
        _activeNotifs = _activeNotifs.filter(function (n) { return !n._disposed; });
        var yy = 12;
        for (var i = 0; i < _activeNotifs.length; i++) {
            _activeNotifs[i]._targetY = yy;
            // Smoothly move to target Y
            _activeNotifs[i].y = yy;
            yy += _activeNotifs[i].height + 8;
        }
    }

    // Static API
    L2_Notification.show = function (opts) {
        opts = opts || {};
        // 限制最大数量
        while (_activeNotifs.length >= _maxVisible) {
            var oldest = _activeNotifs[0];
            if (oldest && oldest._dismiss) oldest._dismiss();
            else _activeNotifs.shift();
        }
        
        // 从对象池获取或创建新实例
        var n = L2_Theme.acquire(_poolName, function () {
            return new L2_Notification(opts);
        });
        
        // 如果是池中的对象，需要重新初始化
        if (n._pooled) {
            n._pooled = false;
            n._nTitle = opts.title || '';
            n._nContent = opts.content || '';
            n._nType = opts.type || 'info';
            n._duration = opts.duration || 180;
            n._placement = opts.placement || 'topRight';
            n._closable = opts.closable !== false;
            n._onClose = opts.onClose || null;
            n._timer = n._duration;
            n._fadeOut = false;
            n._closeHover = false;
            n._disposed = false;
            n._notifId = ++_notifIdCounter;
            
            var nw = 280;
            var contentLines = n._wrapText(n._nContent, nw - 30);
            n._contentLines = contentLines;
            var nh = 24 + contentLines.length * 18 + 16;
            
            var gw = Graphics.boxWidth || 816;
            var startX = n._placement.indexOf('Right') >= 0 ? gw : -nw;
            n.x = startX;
            n.y = 0;
            n.width = nw;
            n.height = nh;
            n._targetX = n._placement.indexOf('Right') >= 0 ? gw - nw - 12 : 12;
            n.visible = true;
            n.opacity = 255;
            n._dirty = true;
        }
        
        _activeNotifs.push(n);
        _repositionNotifs();
        if (SceneManager._scene && SceneManager._scene.addChild) {
            SceneManager._scene.addChild(n);
        }
        n.visible = true;
        n.opacity = 255;
        return n;
    };

    L2_Notification.info = function (title, content, duration) {
        return L2_Notification.show({ title: title, content: content, type: 'info', duration: duration });
    };
    L2_Notification.success = function (title, content, duration) {
        return L2_Notification.show({ title: title, content: content, type: 'success', duration: duration });
    };
    L2_Notification.warning = function (title, content, duration) {
        return L2_Notification.show({ title: title, content: content, type: 'warning', duration: duration });
    };
    L2_Notification.error = function (title, content, duration) {
        return L2_Notification.show({ title: title, content: content, type: 'error', duration: duration });
    };

    window.L2_Notification = L2_Notification;
})();

// ═══ ui/feedback/alert.js ═══
/**
 * L2_Alert - Static alert banner with type, message, and optional close.
 */
(function () {
    'use strict';

    function L2_Alert() { this.initialize.apply(this, arguments); }
    L2_Alert.prototype = Object.create(L2_Base.prototype);
    L2_Alert.prototype.constructor = L2_Alert;

    /**
     * @param {number} x
     * @param {number} y
     * @param {number} w
     * @param {object} [opts] - { title, message, type, closable, onClose }
     */
    L2_Alert.prototype.initialize = function (x, y, w, opts) {
        opts = opts || {};
        this._alertTitle = opts.title || '';
        this._alertMsg = opts.message || '';
        this._alertType = opts.type || 'info'; // 'info' | 'success' | 'warning' | 'error'
        this._closable = opts.closable || false;
        this._onClose = opts.onClose || null;
        this._closeHover = false;
        var h = this._alertTitle ? 52 : 32;
        L2_Base.prototype.initialize.call(this, x, y, w, h);
        this.refresh();
    };

    L2_Alert.prototype.standardPadding = function () { return 0; };

    L2_Alert.prototype._typeColors = function () {
        switch (this._alertType) {
            case 'success': return { bg: '#0D2818', border: L2_Theme.successColor, text: '#52C41A' };
            case 'warning': return { bg: '#2D2200', border: L2_Theme.warningColor, text: '#FAAD14' };
            case 'error': return { bg: '#2D0A0A', border: L2_Theme.dangerColor, text: '#FF4D4F' };
            default: return { bg: '#0A1628', border: L2_Theme.primaryColor, text: '#1890FF' };
        }
    };

    L2_Alert.prototype._typeIcon = function () {
        switch (this._alertType) {
            case 'success': return '✓';
            case 'warning': return '⚠';
            case 'error': return '✕';
            default: return 'ℹ';
        }
    };

    L2_Alert.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var w = this.width, h = this.height;
        var colors = this._typeColors();

        // Background
        L2_Theme.fillRoundRect(c, 0, 0, w, h, 4, colors.bg);
        L2_Theme.strokeRoundRect(c, 0, 0, w, h, 4, colors.border + '66');

        // Icon
        c.fontSize = 14;
        c.textColor = colors.text;
        c.drawText(this._typeIcon(), 10, 0, 18, this._alertTitle ? 28 : h, 'center');

        // Title + Message
        var tx = 32;
        if (this._alertTitle) {
            c.fontSize = L2_Theme.fontNormal;
            c.textColor = colors.text;
            c.drawText(this._alertTitle, tx, 4, w - tx - 30, 20, 'left');
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textGray;
            c.drawText(this._alertMsg, tx, 26, w - tx - 30, 18, 'left');
        } else {
            c.fontSize = L2_Theme.fontSmall;
            c.textColor = L2_Theme.textWhite;
            c.drawText(this._alertMsg, tx, 0, w - tx - 30, h, 'left');
        }

        // Close button
        if (this._closable) {
            L2_Theme.drawCloseBtn(c, w - 22, (h - 14) / 2, this._closeHover);
        }
    };

    L2_Alert.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible || !this._closable) return;
        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x, ly = my - this.y;
        var wasHover = this._closeHover;
        this._closeHover = lx >= this.width - 26 && lx <= this.width - 4 && ly >= 2 && ly <= this.height - 2;
        if (this._closeHover !== wasHover) this.markDirty();
        if (this._closeHover && TouchInput.isTriggered()) {
            this.visible = false;
            if (this.parent) this.parent.removeChild(this);
            if (this._onClose) this._onClose();
        }
    };

    window.L2_Alert = L2_Alert;
})();

// ═══ ui/feedback/popconfirm.js ═══
/**
 * L2_Popconfirm - Small confirmation popup attached to an anchor position.
 */
(function () {
    'use strict';

    function L2_Popconfirm() { this.initialize.apply(this, arguments); }
    L2_Popconfirm.prototype = Object.create(L2_Base.prototype);
    L2_Popconfirm.prototype.constructor = L2_Popconfirm;

    /**
     * @param {number} anchorX - X position to anchor near
     * @param {number} anchorY - Y position to anchor near
     * @param {object} [opts] - { text, okText, cancelText, onOk, onCancel, placement }
     */
    L2_Popconfirm.prototype.initialize = function (anchorX, anchorY, opts) {
        opts = opts || {};
        this._pcText = opts.text || '确定执行此操作？';
        this._okText = opts.okText || '确定';
        this._cancelText = opts.cancelText || '取消';
        this._onOk = opts.onOk || null;
        this._onCancel = opts.onCancel || null;
        this._placement = opts.placement || 'top'; // 'top' | 'bottom'
        this._hoverBtn = -1; // 0=ok, 1=cancel

        var pw = Math.max(this._pcText.length * 8 + 24, 160);
        var ph = 64;

        var px, py;
        if (this._placement === 'bottom') {
            px = anchorX - pw / 2;
            py = anchorY + 8;
        } else {
            px = anchorX - pw / 2;
            py = anchorY - ph - 8;
        }

        // Clamp to screen
        var gw = Graphics.boxWidth || 816;
        var gh = Graphics.boxHeight || 624;
        px = Math.max(4, Math.min(px, gw - pw - 4));
        py = Math.max(4, Math.min(py, gh - ph - 4));

        L2_Base.prototype.initialize.call(this, px, py, pw, ph);
        this.refresh();
    };

    L2_Popconfirm.prototype.standardPadding = function () { return 0; };

    L2_Popconfirm.prototype.refresh = function () {
        var c = this.bmp();
        c.clear();
        var w = this.width, h = this.height;

        // Background
        L2_Theme.fillRoundRect(c, 0, 0, w, h, 6, 'rgba(15,22,40,0.96)');
        L2_Theme.strokeRoundRect(c, 0, 0, w, h, 6, L2_Theme.borderLight);

        // Warning icon + text
        c.fontSize = L2_Theme.fontSmall;
        c.textColor = L2_Theme.warningColor;
        c.drawText('⚠', 8, 6, 16, 20, 'center');
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._pcText, 28, 6, w - 36, 20, 'left');

        // Buttons
        var btnW = 50, btnH = 22, gap = 8;
        var bx = w - btnW * 2 - gap - 10;
        var by = h - btnH - 10;

        // Cancel button
        var cancelBg = this._hoverBtn === 1 ? L2_Theme.bgLight : L2_Theme.borderDark;
        L2_Theme.fillRoundRect(c, bx, by, btnW, btnH, 3, cancelBg);
        c.fontSize = 12;
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._cancelText, bx, by, btnW, btnH, 'center');

        // OK button
        bx += btnW + gap;
        var okBg = this._hoverBtn === 0 ? L2_Theme.lighten(L2_Theme.primaryColor, 0.15) : L2_Theme.primaryColor;
        L2_Theme.fillRoundRect(c, bx, by, btnW, btnH, 3, okBg);
        c.textColor = L2_Theme.textWhite;
        c.drawText(this._okText, bx, by, btnW, btnH, 'center');
    };

    L2_Popconfirm.prototype.update = function () {
        L2_Base.prototype.update.call(this);
        if (!this.visible) return;

        var mx = TouchInput.x, my = TouchInput.y;
        var lx = mx - this.x, ly = my - this.y;
        var w = this.width, h = this.height;
        var btnW = 50, btnH = 22, gap = 8;
        var by = h - btnH - 10;
        var bx0 = w - btnW * 2 - gap - 10;

        var oldHover = this._hoverBtn;
        this._hoverBtn = -1;

        // OK button area
        var okX = bx0 + btnW + gap;
        if (lx >= okX && lx <= okX + btnW && ly >= by && ly <= by + btnH) {
            this._hoverBtn = 0;
        }
        // Cancel button area
        if (lx >= bx0 && lx <= bx0 + btnW && ly >= by && ly <= by + btnH) {
            this._hoverBtn = 1;
        }

        if (this._hoverBtn !== oldHover) this.markDirty();

        if (TouchInput.isTriggered()) {
            if (this._hoverBtn === 0) {
                this._dismiss();
                if (this._onOk) this._onOk();
            } else if (this._hoverBtn === 1) {
                this._dismiss();
                if (this._onCancel) this._onCancel();
            } else if (lx < 0 || lx > w || ly < 0 || ly > h) {
                // Click outside dismisses
                this._dismiss();
                if (this._onCancel) this._onCancel();
            }
        }

        // ESC to cancel
        if (Input.isTriggered('cancel')) {
            this._dismiss();
            if (this._onCancel) this._onCancel();
        }
    };

    L2_Popconfirm.prototype._dismiss = function () {
        if (this._disposed) return;
        this._disposed = true;
        this.visible = false;
        if (this.parent) this.parent.removeChild(this);
        // 清理引用
        this._onOk = null;
        this._onCancel = null;
    };

    window.L2_Popconfirm = L2_Popconfirm;
})();

